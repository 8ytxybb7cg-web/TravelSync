<!DOCTYPE html>
<html lang="zh-HK"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" /> <meta name="robots" content="noindex, nofollow"> <meta name="theme-color" content="#F2F2F7" media="(prefers-color-scheme: light)"> <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)"> <title>Travel Sync Ultimate (v251227-7.02)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<style> /* --- 1. Variables & Base --- */ :root { --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; --ios-bg: #F2F2F7; --hkg-red: #C8102E; } body { font-family: var(--font-stack); background-color: var(--ios-bg); margin: 0; padding-bottom: 100px; user-select: none; -webkit-user-select: none; touch-action: pan-y; color: #1c1c1e; overflow-x: hidden; }
/* Background Layer */
.bg-layer {
    position: fixed; inset: 0; z-index: -1; pointer-events: none;
}

/* Utilities */
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
.pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 20px); }
.pt-safe { padding-top: calc(env(safe-area-inset-top) + 10px); }
[v-cloak] { display: none; }

/* --- 2. Card Systems --- */
.ios-card {
  background: rgba(255, 255, 255, 0.65);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.4);
  border-radius: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.03);
  overflow: hidden;
}
.ios-card-dark {
  background: rgba(30, 30, 30, 0.75);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: white;
}

/* Flight Card Skins */
.flight-card-base {
    border-radius: 20px; min-height: 220px; /* Fixed Height for consistency */
    position: relative; overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    display: flex; flex-direction: column;
    transition: all 0.3s ease;
}

/* Skin: iOS */
.skin-ios {
    background: rgba(20, 20, 25, 0.85);
    border: 1px solid rgba(255,255,255,0.1);
    color: white;
    backdrop-filter: blur(30px);
}
.skin-ios .status-badge {
    background: rgba(255,255,255,0.15);
    padding: 4px 10px; border-radius: 8px;
    font-size: 11px; font-weight: 700; letter-spacing: 1px;
}

/* Skin: HKG */
.skin-hkg {
    background: #FFFFFF;
    border: 1px solid rgba(0,0,0,0.05);
    color: black;
}
.hkg-header {
    background: #F8F8F8; border-bottom: 2px solid #C8102E;
    padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
}
.hkg-footer {
    background: #C8102E; color: white;
    padding: 14px 20px; margin-top: auto;
    display: flex; justify-content: space-between; align-items: center;
}

/* --- 3. Lists &amp; Itinerary --- */
/* iPhone Calendar Style */
.cal-stripe-item {
    background: rgba(255,255,255,0.85);
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding: 12px 16px; display: flex; align-items: flex-start; gap: 12px;
    border-left: 4px solid #007AFF; /* Default Stripe */
    backdrop-filter: blur(10px);
}
.cal-stripe-item:first-child { border-top-right-radius: 12px; }
.cal-stripe-item:last-child { border-bottom-right-radius: 12px; border-bottom: none; }

/* Prep List */
.prep-item {
    background: rgba(255,255,255,0.8);
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding: 14px 16px; display: flex; align-items: center; gap: 12px;
}
.prep-item.done span { text-decoration: line-through; color: #999; }

/* 5.09 Address Popup */
.address-popup {
    position: fixed; top: 0; left: 0; width: 100%; z-index: 100;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(20px);
    padding: 60px 20px 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transform: translateY(-100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
.address-popup.active { transform: translateY(0); }

/* 6.2 Info Alert Style */
.info-alert-card {
    background: rgba(255,255,255,0.9);
    border-left: 5px solid #FF9500;
    padding: 15px; border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    display: flex; gap: 12px; align-items: flex-start;
}

.ios-input {
    background: rgba(118, 118, 128, 0.12);
    border-radius: 10px; padding: 12px;
    font-size: 16px; width: 100%; outline: none; border: none;
}

/* Transitions */
.fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
.fade-enter-from, .fade-leave-to { opacity: 0; }

.slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease; position: fixed; inset: 0; z-index: 200; background: #F2F2F7; }
.slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }

/* Sortable Ghost */
.sortable-ghost { opacity: 0.4; background: #E5E5EA; }
</style>
</head> <body>
<div class="bg-layer"> <img src="./IMG_7005.jpeg" class="w-full h-full object-cover blur-[4px] scale-105" alt="Background"> <div class="absolute inset-0 bg-white/70 backdrop-blur-[2px]"></div> </div>
<div id="app" class="h-full flex flex-col relative" v-cloak>
<div class="address-popup" :class="{ 'active': showAddressCard }">
   <div class="flex justify-between items-start mb-2">
      <h3 class="font-bold text-lg text-gray-800">{{ addressCardData.title }}</h3>
      <button @click="showAddressCard = false" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
         <i class="ph-bold ph-x text-gray-500"></i>
      </button>
   </div>
   <div class="text-sm text-gray-500 mb-4 flex items-center gap-1">
      <i class="ph-fill ph-map-pin text-red-500"></i>
      {{ addressCardData.location }}
   </div>
   <div class="grid grid-cols-2 gap-3">
      <a :href="getGoogleMapUrl(addressCardData.location)" target="_blank" class="py-3 bg-gray-100 rounded-xl font-bold text-gray-700 flex items-center justify-center gap-2">
         <i class="ph-bold ph-map-trifold"></i> Map
      </a>
      <a :href="getGoogleNavUrl(addressCardData.location)" target="_blank" class="py-3 bg-blue-500 rounded-xl font-bold text-white flex items-center justify-center gap-2">
         <i class="ph-bold ph-navigation-arrow"></i> GO
      </a>
   </div>
</div>

<main v-if="currentTab === 'home'" class="flex-1 overflow-y-auto overflow-x-hidden pb-32 no-scrollbar">
  
  <header class="pt-safe px-5 pb-2 flex justify-between items-start z-10 sticky top-0 bg-white/50 backdrop-blur-md transition-all">
    <div class="flex flex-col pt-1">
       <span class="text-[11px] font-semibold text-gray-500 tracking-wide uppercase mb-0.5">
         {{ formattedDateRange }}
       </span>
       <div class="flex items-center gap-2">
         <h1 class="text-3xl font-black tracking-tight flex items-center gap-2 text-black">
           {{ settings.origin.toUpperCase() }} 
           <span class="text-blue-500 text-2xl">✈️</span>
           {{ settings.destination.toUpperCase() }}
         </h1>
       </div>
    </div>
    <div class="flex flex-col items-end pt-1">
       <button @click="toggleLang" class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center active:scale-90 transition-transform border border-gray-100">
         <span class="text-xs font-bold text-gray-600">{{ lang === 'zh' ? 'EN' : '中' }}</span>
       </button>
       <button @click="openSubPage('settings')" class="w-10 h-10 mt-2 rounded-full bg-white shadow-sm flex items-center justify-center active:scale-90 transition-transform border border-gray-100">
         <i class="ph-fill ph-gear text-lg text-gray-600"></i>
       </button>
    </div>
  </header>

  <div class="px-5 space-y-6 mt-2">

    <div class="relative group">
       <button @click="openSubPage('flightEdit')" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-black/10 flex items-center justify-center text-white backdrop-blur-md hover:bg-black/30 transition-all">
          <i class="ph-fill ph-pencil-simple text-sm"></i>
       </button>

       <div v-if="flightSkin === 'hkg'" class="flight-card-base skin-hkg">
           <div class="p-5 flex-1 relative">
              <div class="flex justify-between items-start">
                  <div class="flex items-center gap-2">
                     <i class="ph-fill ph-airplane-tilt text-red-600 text-xl"></i>
                     <span class="font-bold text-gray-800 tracking-tight">{{ activeFlight.airline }}</span>
                  </div>
                  <span class="font-mono font-bold text-gray-400">{{ activeFlight.code }}</span>
              </div>
              <div class="mt-4 flex justify-between items-end">
                  <div class="text-center">
                      <div class="text-4xl font-black text-gray-900">{{ activeFlight.time }}</div>
                      <div class="text-xs text-gray-400 mt-1 uppercase tracking-wider font-bold">{{ t('departure') }}</div>
                  </div>
                  <div class="pb-2">
                     <i class="ph-duotone ph-arrow-right text-gray-300 text-2xl"></i>
                  </div>
              </div>
              <div class="mt-4 text-center">
                  <div class="text-[10px] text-gray-400 font-bold uppercase tracking-[2px]">{{ t('gate') }}</div>
                  <div class="text-6xl font-black text-gray-900 leading-none tracking-tighter">{{ activeFlight.gate }}</div>
              </div>
           </div>
           <div class="hkg-footer">
               <div>
                   <div class="text-[9px] opacity-80 font-bold uppercase">{{ t('terminal') }}</div>
                   <div class="text-xl font-bold">{{ activeFlight.terminal }}</div>
               </div>
               <div class="text-right">
                   <span class="px-2 py-0.5 bg-white/20 rounded text-[10px] font-bold uppercase tracking-wider">{{ activeFlight.status }}</span>
               </div>
           </div>
           <div class="absolute top-[18px] left-0 w-full flex justify-center pointer-events-none">
              <div class="bg-gray-100 rounded-lg p-0.5 flex pointer-events-auto shadow-inner">
                 <button @click="isReturnFlight=false" :class="!isReturnFlight?'bg-white shadow text-red-600':'text-gray-400'" class="px-3 py-1 text-[9px] font-bold rounded-md transition-all">OUT</button>
                 <button @click="isReturnFlight=true" :class="isReturnFlight?'bg-white shadow text-red-600':'text-gray-400'" class="px-3 py-1 text-[9px] font-bold rounded-md transition-all">IN</button>
              </div>
           </div>
       </div>

       <div v-else class="flight-card-base skin-ios p-6 flex flex-col justify-between">
           <div class="flex justify-center mb-2">
              <div class="bg-white/10 p-0.5 rounded-lg flex backdrop-blur-md">
                 <button @click="isReturnFlight=false" :class="!isReturnFlight?'bg-white/20 text-white':'text-white/40'" class="px-3 py-1 text-[10px] font-bold rounded-md transition-all">OUTBOUND</button>
                 <button @click="isReturnFlight=true" :class="isReturnFlight?'bg-white/20 text-white':'text-white/40'" class="px-3 py-1 text-[10px] font-bold rounded-md transition-all">INBOUND</button>
              </div>
           </div>
           <div class="flex justify-between items-end">
               <div>
                   <div class="text-4xl font-bold tracking-tight">{{ activeFlight.code }}</div>
                   <div class="text-xs text-blue-300 font-medium mt-1">{{ activeFlight.airline }}</div>
               </div>
               <div class="text-right">
                   <span :class="getStatusClass(activeFlight.status)" class="status-badge">{{ activeFlight.status.toUpperCase() }}</span>
               </div>
           </div>
           <div class="flex justify-between items-end mt-4">
               <div>
                   <div class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">{{ t('terminal') }} {{ activeFlight.terminal }}</div>
                   <div class="text-[10px] text-gray-400 uppercase tracking-widest">{{ t('gate') }} <span class="text-white text-xl font-bold ml-1">{{ activeFlight.gate }}</span></div>
               </div>
               <div class="text-5xl font-light tracking-tight">{{ activeFlight.time }}</div>
           </div>
       </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
       <div class="ios-card p-4 flex flex-col justify-between h-44">
          <div class="flex justify-between items-start">
             <div class="flex flex-col">
                <span class="text-xs font-bold text-gray-400 uppercase truncate w-20">{{ displayCity }}</span>
                <span class="text-4xl font-light mt-1 tracking-tighter">{{ weather.temp }}°</span>
             </div>
             <i :class="[weather.icon, weather.color]" class="ph-fill text-3xl"></i>
          </div>
          <div class="text-[10px] font-bold text-blue-500 mt-1 flex items-center gap-1">
             <i class="ph-bold ph-cloud-rain"></i> {{ weather.precip }}% Rain
          </div>
          <div class="grid grid-cols-2 gap-x-1 gap-y-1 mt-auto pt-2 border-t border-gray-100/50">
             <div class="flex items-center gap-1 text-[9px] text-gray-500"><i class="ph-bold ph-thermometer text-gray-400"></i> {{ weather.feelsLike }}°</div>
             <div class="flex items-center gap-1 text-[9px] text-gray-500"><i class="ph-bold ph-drop text-blue-400"></i> {{ weather.humidity }}% Hum</div>
             <div class="flex items-center gap-1 text-[9px] text-gray-500"><i class="ph-bold ph-sun-dim text-orange-400"></i> UV {{ weather.uv }}</div>
             <div class="flex items-center gap-1 text-[9px] text-gray-500"><i class="ph-bold ph-wind text-gray-400"></i> {{ weather.wind }}km</div>
          </div>
       </div>

       <div class="ios-card p-4 flex flex-col justify-between h-44 relative">
          <div class="flex justify-between items-center z-10">
             <div class="flex items-center gap-1 text-[10px] font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-lg" @click="toggleRateMode">
                 <span>{{ rateDisplayMode === 'S_to_L' ? settings.currency.settle : settings.currency.local }}</span>
                 <i class="ph-bold ph-arrows-left-right text-blue-500"></i>
                 <span>{{ rateDisplayMode === 'S_to_L' ? settings.currency.local : settings.currency.settle }}</span>
             </div>
          </div>
          <div class="z-10 mt-2">
             <div class="text-3xl font-semibold tracking-tight text-gray-800 break-all">
                {{ getRateDisplayValue() }}
             </div>
             <div class="text-[9px] text-gray-400 mt-1">
                Rate: {{ baseRate.toFixed(4) }}
             </div>
             <div class="text-[8px] text-red-400 mt-2 font-medium bg-red-50 inline-block px-1.5 py-0.5 rounded">
                +3% Fee Included
             </div>
          </div>
       </div>
    </div>

    <div>
       <div class="flex justify-between items-center mb-2 px-1">
          <h3 class="text-lg font-bold text-gray-800">{{ t('expense') }}</h3>
       </div>
       <div class="ios-card-dark p-0 overflow-hidden relative">
          <div class="absolute inset-0 bg-gradient-to-br from-gray-800 to-black opacity-90"></div>
          
          <button @click="openSubPage('expenseEdit')" class="absolute top-0 right-0 w-12 h-12 flex items-center justify-center text-white/30 hover:text-white z-20 hover:bg-white/10 rounded-bl-2xl">
              <i class="ph-bold ph-plus text-lg"></i>
          </button>

          <div class="relative z-10 p-5 text-center border-b border-white/10">
             <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{{ t('totalExpense') }} ({{ settings.currency.settle }})</div>
             <div class="text-4xl font-bold text-white mt-2 tracking-tight">{{ formatNumber(totalExpense.settle) }}</div>
             <div class="text-xs text-blue-300 mt-1 font-medium">≈ {{ formatNumber(totalExpense.local) }} {{ settings.currency.local }}</div>
          </div>
          <div class="relative z-10 grid grid-cols-2 divide-x divide-white/10">
             <div class="p-3 flex flex-col items-center">
                <div class="text-[9px] text-gray-400 uppercase mb-1">{{ t('card') }}</div>
                <div class="text-base font-bold text-white">{{ formatNumber(expensesBreakdown.card.settle) }}</div>
             </div>
             <div class="p-3 flex flex-col items-center">
                <div class="text-[9px] text-gray-400 uppercase mb-1">{{ t('cash') }}</div>
                <div class="text-base font-bold text-white">{{ formatNumber(expensesBreakdown.cash.settle) }}</div>
             </div>
          </div>
       </div>
    </div>

    <div v-if="infoList.length > 0">
       <div class="flex justify-between items-center mb-2 px-1">
          <h3 class="text-lg font-bold text-gray-800">{{ t('tripInfo') }}</h3>
          <button @click="openSubPage('info')" class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center">
             <i class="ph-bold ph-pencil-simple text-xs"></i>
          </button>
       </div>
       <div class="space-y-3">
           <div v-for="info in infoList.slice(0, 2)" :key="info.id" class="info-alert-card" @click="editInfo(info)">
              <i class="ph-duotone ph-info text-orange-500 text-xl flex-shrink-0 mt-0.5"></i>
              <div class="overflow-hidden">
                  <div class="font-bold text-gray-800 text-sm mb-0.5">{{ info.title }}</div>
                  <div class="text-xs text-gray-500 truncate">{{ info.content }}</div>
              </div>
           </div>
       </div>
    </div>

    <div>
       <div class="flex justify-between items-end mb-2 px-1">
          <h3 class="text-lg font-bold text-gray-800">{{ t('itinerary') }}</h3>
       </div>
       
       <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 pl-1 snap-x">
          <div v-for="(day, idx) in tripDays" :key="idx" 
               class="flex-shrink-0 w-16 h-20 rounded-xl flex flex-col items-center justify-center snap-start border transition-all"
               :class="selectedDayIndex === idx ? 'bg-black text-white border-black shadow-lg scale-105' : 'bg-white border-gray-200 text-gray-400'"
               @click="selectedDayIndex = idx">
             <span class="text-[9px] font-bold uppercase tracking-wider mb-0.5">DAY {{ idx + 1 }}</span>
             <span class="text-[10px] font-medium opacity-80">{{ day.weekday }}</span>
             <span class="text-xl font-bold mt-0.5 leading-none">{{ day.dateStr }}</span>
          </div>
          <div @click="openItineraryAdd" class="flex-shrink-0 w-16 h-20 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 snap-start active:bg-gray-100">
              <i class="ph-bold ph-plus text-xl"></i>
          </div>
       </div>
       
       <div class="mt-2 space-y-2 min-h-[60px]">
          <div v-for="item in currentDayItinerary" :key="item.id" 
               class="cal-stripe-item rounded-xl group active:scale-[0.99] transition-transform"
               @click="handleItineraryClick(item)">
             <div class="flex-1 min-w-0">
                <div class="font-bold text-gray-900 text-sm truncate">{{ item.title }}</div>
                <div class="text-xs text-gray-500 mt-0.5 truncate flex items-center gap-1">
                    <i v-if="item.location" class="ph-fill ph-map-pin text-[10px]"></i>
                    {{ item.location || 'No Location' }}
                </div>
             </div>
             <div class="text-xs font-bold text-gray-400 whitespace-nowrap pt-0.5">{{ item.time }}</div>
          </div>
          <div v-if="currentDayItinerary.length === 0" class="text-center py-6 text-xs text-gray-400 bg-white/50 rounded-xl border border-dashed border-gray-200">
             {{ t('noActivity') }}
          </div>
       </div>
    </div>

    <div>
       <div class="flex justify-between items-center mb-2 px-1">
          <h3 class="text-lg font-bold text-gray-800">{{ t('prepList') }}</h3>
          <button @click="openSubPage('prep')" class="w-8 h-8 rounded-full bg-blue-500 text-white shadow flex items-center justify-center">
             <i class="ph-bold ph-plus"></i>
          </button>
       </div>
       <div class="rounded-xl overflow-hidden shadow-sm" ref="homePrepListRef">
          <div v-for="item in prepList" :key="item.id" class="prep-item bg-white" :class="{ 'done': item.done }">
             <div @click="togglePrep(item)" class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors flex-shrink-0"
                  :class="item.done ? 'bg-green-500 border-green-500' : 'border-gray-300'">
                <i v-if="item.done" class="ph-bold ph-check text-white text-[10px]"></i>
             </div>
             <span class="text-sm font-medium flex-1 text-gray-800">{{ item.text }}</span>
             <button @click="editPrep(item)" class="text-gray-400 p-2"><i class="ph-bold ph-pencil-simple"></i></button>
          </div>
       </div>
    </div>

    <div>
       <div class="flex justify-between items-center mb-2 px-1">
          <h3 class="text-lg font-bold text-gray-800">{{ t('shoppingList') }}</h3>
          <button @click="openSubPage('shopping')" class="w-8 h-8 rounded-full bg-blue-500 text-white shadow flex items-center justify-center">
             <i class="ph-bold ph-plus"></i>
          </button>
       </div>
       <div class="grid grid-cols-2 gap-3">
          <div v-for="item in shoppingList" :key="item.id" 
               class="ios-card p-3 flex flex-col gap-2 relative bg-white"
               @click="editShopping(item)">
             
             <div v-if="isInstagramLink(item.link)" @click.stop="openLink(item.link)" 
                  class="absolute top-2 right-2 z-20 w-6 h-6 bg-white/90 rounded-full flex items-center justify-center shadow-sm">
                 <i class="ph-bold ph-instagram-logo text-pink-500"></i>
             </div>

             <div class="h-24 bg-gray-100 rounded-lg overflow-hidden relative">
                <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                <div v-else class="w-full h-full flex items-center justify-center text-gray-300"><i class="ph-duotone ph-image text-3xl"></i></div>
                <div v-if="item.done" class="absolute inset-0 bg-black/40 flex items-center justify-center backdrop-blur-sm">
                    <i class="ph-fill ph-check-circle text-white text-3xl"></i>
                </div>
             </div>
             <div>
                <div class="text-xs font-bold truncate text-gray-800" :class="item.done ? 'line-through text-gray-400' : ''">{{ item.name }}</div>
                <div v-if="item.price" class="text-[10px] text-gray-500 mt-0.5">{{ formatNumber(item.price) }}</div>
             </div>
          </div>
       </div>
    </div>
    
    <div class="h-8"></div>

  </div>
</main>

<main v-if="currentTab === 'itinerary'" class="flex-1 overflow-y-auto pb-32 pt-safe px-5 bg-white">
    <h2 class="text-3xl font-bold mb-4 text-black">{{ t('itinerary') }}</h2>
    
    <div class="sticky top-0 z-20 bg-white/95 backdrop-blur-xl py-2 -mx-5 px-5 border-b border-gray-100">
       <div class="flex gap-3 overflow-x-auto no-scrollbar snap-x">
          <div v-for="(day, idx) in tripDays" :key="idx" 
               class="flex-shrink-0 w-16 h-20 rounded-xl flex flex-col items-center justify-center snap-start border transition-all"
               :class="selectedDayIndex === idx ? 'bg-black text-white border-black' : 'bg-gray-50 border-gray-100 text-gray-400'"
               @click="selectedDayIndex = idx">
             <span class="text-[9px] font-bold uppercase mb-0.5">DAY {{ idx + 1 }}</span>
             <span class="text-[10px] font-medium">{{ day.weekday }}</span>
             <span class="text-xl font-bold mt-0.5">{{ day.dateStr }}</span>
          </div>
       </div>
    </div>

    <div class="mt-6 space-y-3" ref="itineraryListRef">
        <div v-for="item in currentDayItinerary" :key="item.id" :data-id="item.id"
             class="cal-stripe-item rounded-xl group active:scale-[0.98] transition-transform cursor-move"
             @click="handleItineraryClick(item)">
           <div class="flex-1 min-w-0">
              <div class="font-bold text-gray-900 text-base truncate">{{ item.title }}</div>
              <div class="text-sm text-gray-500 mt-1 truncate flex items-center gap-1">
                  <i v-if="item.location" class="ph-fill ph-map-pin text-gray-400"></i>
                  {{ item.location }}
              </div>
              <div v-if="item.desc" class="text-xs text-gray-400 mt-1 line-clamp-1">{{ item.desc }}</div>
           </div>
           <div class="flex flex-col items-end gap-2">
               <div class="text-sm font-bold text-gray-600 bg-gray-100 px-2 py-1 rounded">{{ item.time }}</div>
               <i class="ph-bold ph-dots-six-vertical text-gray-300"></i>
           </div>
        </div>
    </div>
    
    <button @click="openItineraryAdd" class="w-full mt-4 py-4 rounded-xl border-2 border-dashed border-gray-200 text-gray-400 font-bold flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors">
        <i class="ph-bold ph-plus-circle text-xl"></i>
        {{ t('add') }}
    </button>
</main>

<main v-if="currentTab === 'expense'" class="flex-1 overflow-y-auto pb-32 pt-safe px-5 bg-gray-50">
        <div class="flex justify-between items-center mb-6">
           <h2 class="text-3xl font-bold text-black">{{ t('expense') }}</h2>
           <button @click="openSubPage('expenseEdit')" class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center shadow-lg active:scale-90 transition-transform">
              <i class="ph-bold ph-plus text-xl"></i>
           </button>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-sm mb-6 border border-gray-100">
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">{{ t('settlement') }}</h3>
            <div class="space-y-4">
                <div v-for="m in members" :key="m" class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-sm font-bold text-gray-600 border border-gray-200">{{ m.charAt(0) }}</div>
                        <span class="text-base font-bold text-gray-900">{{ m }}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-gray-400 uppercase font-bold">{{ t('paid') }}</div>
                        <div class="font-mono font-bold text-lg text-gray-900">
                           {{ formatNumber(getMemberPaid(m)) }} <span class="text-xs text-gray-500">{{ settings.currency.settle }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-5 pt-4 border-t border-gray-100 flex justify-between items-end">
                <div class="text-xs font-bold text-gray-400 uppercase">{{ t('total') }}</div>
                <div class="text-2xl font-black text-gray-900">{{ formatNumber(totalExpense.settle) }} <span class="text-sm font-bold text-gray-400">{{ settings.currency.settle }}</span></div>
            </div>
        </div>

        <div class="space-y-3">
            <div v-for="exp in expenses" :key="exp.id" @click="editExpenseItem(exp)"
                 class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center active:scale-[0.99] transition-transform">
                <div class="flex items-center gap-4">
                   <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 text-xl">
                      <i :class="getCategoryIcon(exp.category)"></i>
                   </div>
                   <div>
                      <div class="font-bold text-base text-gray-900">{{ exp.item || t(exp.category) }}</div>
                      <div class="text-xs text-gray-400 mt-0.5">{{ exp.payer }} • {{ formatDate(exp.date) }}</div>
                   </div>
                </div>
                <div class="text-right">
                   <div class="font-bold text-lg text-gray-900">{{ formatNumber(exp.amount) }} <span class="text-xs text-gray-500">{{ exp.currency }}</span></div>
                   <div v-if="exp.currency !== settings.currency.settle" class="text-[10px] text-gray-400 font-medium">
                      ≈ {{ formatNumber(toSettle(exp.amount, exp.currency)) }} {{ settings.currency.settle }}
                   </div>
                </div>
            </div>
        </div>
    </main>

    <main v-if="currentTab === 'info'" class="flex-1 overflow-y-auto pb-32 pt-safe px-5 bg-gray-50">
         <h2 class="text-3xl font-bold mb-6 text-black">{{ t('info') }}</h2>
         <div class="grid grid-cols-1 gap-4">
             <div v-for="info in infoList" :key="info.id" @click="editInfo(info)" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 active:scale-[0.99] transition-transform">
                 <h3 class="font-bold text-lg text-gray-900 mb-2">{{ info.title }}</h3>
                 <p class="text-sm text-gray-500 whitespace-pre-wrap leading-relaxed">{{ info.content }}</p>
             </div>
             <button @click="openSubPage('info')" class="w-full py-4 rounded-xl bg-white border-2 border-dashed border-gray-300 text-gray-400 font-bold hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                 <i class="ph-bold ph-plus"></i> {{ t('add') }}
             </button>
         </div>
    </main>

    <transition name="slide-up">
      
      <div v-if="activeSubPage === 'settings'" class="fixed inset-0 bg-[#F2F2F7] z-50 flex flex-col">
        <div class="bg-white px-5 pt-safe pb-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
           <button @click="closeSubPage" class="text-blue-500 font-medium text-lg flex items-center gap-1">
             <i class="ph-bold ph-caret-left"></i> {{ t('back') }}
           </button>
           <span class="font-bold text-lg text-gray-900">{{ t('settings') }}</span>
           <div class="w-16"></div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-5 space-y-8">
           <section>
              <h4 class="text-xs font-bold text-gray-400 uppercase mb-2 ml-3 tracking-wider">{{ t('appearance') }}</h4>
              <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-200/50">
                 <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                    <span class="text-base font-medium text-gray-900">{{ t('language') }}</span>
                    <div class="bg-gray-100 p-1 rounded-lg flex">
                       <button @click="toggleLang('zh')" :class="lang==='zh'?'bg-white shadow text-black':'text-gray-400'" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all">繁體</button>
                       <button @click="toggleLang('en')" :class="lang==='en'?'bg-white shadow text-black':'text-gray-400'" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all">EN</button>
                    </div>
                 </div>
                 <div class="p-4 flex justify-between items-center">
                    <span class="text-base font-medium text-gray-900">{{ t('flightSkin') }}</span>
                    <div class="bg-gray-100 p-1 rounded-lg flex">
                       <button @click="flightSkin='ios'; saveLocalSettings()" :class="flightSkin==='ios'?'bg-white shadow text-black':'text-gray-400'" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all">iOS</button>
                       <button @click="flightSkin='hkg'; saveLocalSettings()" :class="flightSkin==='hkg'?'bg-white shadow text-black':'text-gray-400'" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all">HKG</button>
                    </div>
                 </div>
              </div>
           </section>

           <section>
              <h4 class="text-xs font-bold text-gray-400 uppercase mb-2 ml-3 tracking-wider">{{ t('tripData') }}</h4>
              <div class="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-200/50">
                 <div class="flex border-b border-gray-100">
                    <div class="flex-1 p-4 border-r border-gray-100">
                       <label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">{{ t('origin') }}</label>
                       <input v-model="settings.origin" @change="saveToCloud('settings', settings)" class="w-full font-bold text-xl outline-none uppercase bg-transparent" placeholder="HKG">
                    </div>
                    <div class="flex-1 p-4">
                       <label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">{{ t('destination') }}</label>
                       <input v-model="settings.destination" @change="saveToCloud('settings', settings)" class="w-full font-bold text-xl outline-none uppercase bg-transparent" placeholder="KIX">
                    </div>
                 </div>
                 <div class="p-4 border-b border-gray-100 grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">Start</label>
                        <input type="date" v-model="settings.dateRange.start" @change="saveToCloud('settings', settings)" class="bg-gray-50 rounded-lg px-2 py-1 w-full text-sm font-bold">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">End</label>
                        <input type="date" v-model="settings.dateRange.end" @change="saveToCloud('settings', settings)" class="bg-gray-50 rounded-lg px-2 py-1 w-full text-sm font-bold">
                    </div>
                 </div>
                 <div class="p-4 flex justify-between items-center">
                    <label class="text-base font-medium text-gray-900">{{ t('weatherCity') }}</label>
                    <input v-model="settings.weatherCity" @change="saveToCloud('settings', settings)" class="text-right font-medium text-gray-600 outline-none bg-transparent" placeholder="Osaka">
                 </div>
              </div>
           </section>
           
           <section>
               <button @click="resetData" class="w-full py-4 bg-white rounded-xl text-red-500 font-bold shadow-sm border border-gray-100 active:bg-gray-50">{{ t('resetData') }}</button>
           </section>
        </div>
      </div>

      <div v-else-if="activeSubPage === 'expenseEdit'" class="fixed inset-0 bg-white z-50 flex flex-col">
          <div class="px-5 pt-safe pb-4 border-b border-gray-100 flex justify-between items-center">
             <button @click="closeSubPage" class="text-blue-500 font-medium text-lg">{{ t('cancel') }}</button>
             <span class="font-bold text-lg">{{ editingId ? t('edit') : t('new') }}</span>
             <button @click="saveExpense" class="text-blue-500 font-bold text-lg">{{ t('save') }}</button>
          </div>
          <div class="p-5 space-y-5 bg-gray-50 flex-1">
              <div class="bg-white p-4 rounded-xl shadow-sm">
                  <div class="text-[10px] text-gray-400 font-bold uppercase mb-2">{{ t('amount') }}</div>
                  <div class="flex items-end gap-2">
                      <input v-model="editingExpense.amount" type="number" class="text-4xl font-black text-gray-900 bg-transparent outline-none w-full" placeholder="0">
                      <select v-model="editingExpense.currency" class="text-xl font-bold bg-gray-100 rounded-lg px-2 py-1 mb-1 outline-none">
                          <option :value="settings.currency.local">{{ settings.currency.local }}</option>
                          <option :value="settings.currency.settle">{{ settings.currency.settle }}</option>
                      </select>
                  </div>
              </div>
              <input v-model="editingExpense.item" class="ios-input bg-white shadow-sm" :placeholder="t('itemName')">
              
              <div class="grid grid-cols-3 gap-3">
                  <div v-for="cat in expenseCats" :key="cat.id" 
                       @click="editingExpense.category = cat.id"
                       class="flex flex-col items-center gap-2 p-3 rounded-xl border transition-all"
                       :class="editingExpense.category === cat.id ? 'bg-blue-50 border-blue-500 text-blue-500' : 'bg-white border-transparent text-gray-400 shadow-sm'">
                      <i :class="[getCategoryIcon(cat.id), editingExpense.category === cat.id ? 'ph-fill' : 'ph-bold']" class="text-2xl"></i>
                      <span class="text-[10px] font-bold uppercase">{{ t(cat.id) }}</span>
                  </div>
              </div>
              
              <div class="bg-white p-4 rounded-xl shadow-sm space-y-4">
                  <div class="flex justify-between items-center">
                      <span class="text-sm font-bold">{{ t('payer') }}</span>
                      <select v-model="editingExpense.payer" class="bg-gray-100 rounded-lg px-3 py-1.5 text-sm font-bold outline-none">
                          <option v-for="m in members" :key="m" :value="m">{{ m }}</option>
                      </select>
                  </div>
                  <div class="flex justify-between items-center">
                      <span class="text-sm font-bold">{{ t('method') }}</span>
                      <div class="flex bg-gray-100 p-1 rounded-lg">
                         <button @click="editingExpense.method='cash'" :class="editingExpense.method==='cash'?'bg-white shadow text-black':'text-gray-400'" class="px-3 py-1 rounded text-xs font-bold">{{ t('cash') }}</button>
                         <button @click="editingExpense.method='card'" :class="editingExpense.method==='card'?'bg-white shadow text-black':'text-gray-400'" class="px-3 py-1 rounded text-xs font-bold">{{ t('card') }}</button>
                      </div>
                  </div>
              </div>
              <button v-if="editingId" @click="deleteItem" class="w-full py-4 text-red-500 font-bold bg-white rounded-xl shadow-sm">{{ t('delete') }}</button>
          </div>
      </div>

      <div v-else-if="activeSubPage === 'shopping'" class="fixed inset-0 bg-white z-50 flex flex-col">
          <div class="px-5 pt-safe pb-4 border-b border-gray-100 flex justify-between items-center">
              <button @click="closeSubPage" class="text-blue-500 font-medium text-lg">{{ t('cancel') }}</button>
              <span class="font-bold text-lg">{{ editingId ? t('edit') : t('new') }}</span>
              <button @click="saveGenericItem" class="text-blue-500 font-bold text-lg">{{ t('save') }}</button>
          </div>
          <div class="p-5 space-y-5 bg-gray-50 flex-1">
              <div class="flex justify-center">
                  <div class="w-48 h-48 rounded-2xl bg-white border-2 border-dashed border-gray-300 flex items-center justify-center relative overflow-hidden shadow-sm" @click="triggerFileUpload">
                      <img v-if="tempUploadPreview || editingItem.image" :src="tempUploadPreview || editingItem.image" class="w-full h-full object-cover">
                      <div v-else class="flex flex-col items-center text-gray-400">
                          <i class="ph-duotone ph-camera text-4xl mb-2"></i>
                          <span class="text-[10px] font-bold uppercase">{{ t('tapToUpload') }}</span>
                      </div>
                      <input type="file" ref="fileInput" accept="image/*" @change="handleFileUpload" class="hidden">
                      <div v-if="isUploading" class="absolute inset-0 bg-black/50 flex items-center justify-center">
                          <i class="ph-bold ph-spinner animate-spin text-white text-3xl"></i>
                      </div>
                  </div>
              </div>

              <input v-model="editingItem.name" class="ios-input bg-white shadow-sm" :placeholder="t('itemName')">
              <input v-model="editingItem.price" type="number" class="ios-input bg-white shadow-sm" :placeholder="t('price')">
              <div class="relative">
                  <input v-model="editingItem.link" class="ios-input bg-white shadow-sm pr-10" placeholder="URL / Instagram">
                  <i v-if="isInstagramLink(editingItem.link)" class="ph-bold ph-instagram-logo text-pink-500 text-xl absolute right-3 top-3"></i>
              </div>
              <button v-if="editingId" @click="deleteItem" class="w-full py-4 text-red-500 font-bold bg-white rounded-xl shadow-sm">{{ t('delete') }}</button>
          </div>
      </div>

      <div v-else-if="activeSubPage === 'itinerary'" class="fixed inset-0 bg-white z-50 flex flex-col">
          <div class="px-5 pt-safe pb-4 border-b border-gray-100 flex justify-between items-center">
              <button @click="closeSubPage" class="text-blue-500 font-medium text-lg">{{ t('cancel') }}</button>
              <span class="font-bold text-lg">{{ editingId ? t('edit') : t('new') }}</span>
              <button @click="saveGenericItem" class="text-blue-500 font-bold text-lg">{{ t('save') }}</button>
          </div>
          <div class="p-5 space-y-5 bg-gray-50 flex-1">
              <div class="bg-white p-4 rounded-xl shadow-sm grid grid-cols-2 gap-4">
                  <div>
                      <label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">Day</label>
                      <select v-model="editingItem.dayIndex" class="w-full bg-gray-100 rounded-lg px-2 py-2 font-bold outline-none">
                          <option v-for="(d,i) in tripDays" :key="i" :value="i">Day {{i+1}} - {{d.weekday}}</option>
                      </select>
                  </div>
                  <div>
                      <label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">{{ t('time') }}</label>
                      <input type="time" v-model="editingItem.time" class="w-full bg-gray-100 rounded-lg px-2 py-2 font-bold outline-none">
                  </div>
              </div>
              <input v-model="editingItem.title" class="ios-input bg-white shadow-sm font-bold" :placeholder="t('title')">
              <div class="relative">
                  <i class="ph-fill ph-map-pin absolute left-3 top-3.5 text-gray-400"></i>
                  <input v-model="editingItem.location" class="ios-input bg-white shadow-sm pl-9" :placeholder="t('locationAddr')">
              </div>
              <textarea v-model="editingItem.desc" class="ios-input bg-white shadow-sm h-32 pt-3" :placeholder="t('notes')"></textarea>
              <button v-if="editingId" @click="deleteItem" class="w-full py-4 text-red-500 font-bold bg-white rounded-xl shadow-sm">{{ t('delete') }}</button>
          </div>
      </div>

      <div v-else-if="activeSubPage === 'flightEdit'" class="fixed inset-0 bg-white z-50 flex flex-col">
         <div class="px-5 pt-safe pb-4 border-b border-gray-100 flex justify-between items-center">
             <button @click="closeSubPage" class="text-blue-500 font-medium text-lg">{{ t('cancel') }}</button>
             <span class="font-bold text-lg">{{ t('editFlight') }}</span>
             <button @click="saveFlight" class="text-blue-500 font-bold text-lg">{{ t('save') }}</button>
         </div>
         <div class="p-5 space-y-5 bg-gray-50 flex-1">
             <div class="flex bg-gray-200 p-1 rounded-xl">
                 <button @click="editingFlightType='outbound'" :class="editingFlightType==='outbound'?'bg-white shadow text-black':'text-gray-400'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all">{{ t('outbound') }}</button>
                 <button @click="editingFlightType='inbound'" :class="editingFlightType==='inbound'?'bg-white shadow text-black':'text-gray-400'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all">{{ t('inbound') }}</button>
             </div>
             <div class="space-y-3">
                 <input v-model="editingFlight.code" class="ios-input bg-white shadow-sm font-mono uppercase" placeholder="CX400">
                 <input v-model="editingFlight.airline" class="ios-input bg-white shadow-sm" :placeholder="t('airline')">
                 <input v-model="editingFlight.time" type="time" class="ios-input bg-white shadow-sm font-bold text-lg">
                 <div class="grid grid-cols-2 gap-3">
                     <input v-model="editingFlight.terminal" class="ios-input bg-white shadow-sm text-center uppercase" :placeholder="t('terminal')">
                     <input v-model="editingFlight.gate" class="ios-input bg-white shadow-sm text-center uppercase" :placeholder="t('gate')">
                 </div>
                 <select v-model="editingFlight.status" class="ios-input bg-white shadow-sm h-[48px]">
                     <option value="On Time">On Time</option>
                     <option value="Delayed">Delayed</option>
                     <option value="Boarding">Boarding</option>
                     <option value="Landed">Landed</option>
                 </select>
             </div>
         </div>
      </div>
      
      <div v-else-if="activeSubPage === 'prep' || activeSubPage === 'info'" class="fixed inset-0 bg-white z-50 flex flex-col">
          <div class="px-5 pt-safe pb-4 border-b border-gray-100 flex justify-between items-center">
              <button @click="closeSubPage" class="text-blue-500 font-medium text-lg">{{ t('cancel') }}</button>
              <span class="font-bold text-lg">{{ editingId ? t('edit') : t('new') }}</span>
              <button @click="saveGenericItem" class="text-blue-500 font-bold text-lg">{{ t('save') }}</button>
          </div>
          <div class="p-5 space-y-4 bg-gray-50 flex-1">
              <template v-if="activeSubPage === 'prep'">
                  <input v-model="editingItem.text" class="ios-input bg-white shadow-sm" :placeholder="t('itemName')">
              </template>
              <template v-else>
                  <input v-model="editingItem.title" class="ios-input bg-white shadow-sm font-bold" :placeholder="t('title')">
                  <textarea v-model="editingItem.content" class="ios-input bg-white shadow-sm h-40 pt-3" :placeholder="t('notes')"></textarea>
              </template>
              <button v-if="editingId" @click="deleteItem" class="w-full py-4 text-red-500 font-bold bg-white rounded-xl shadow-sm">{{ t('delete') }}</button>
          </div>
      </div>

    </transition>

    <nav class="fixed bottom-0 w-full bg-white/90 backdrop-blur-xl border-t border-gray-200 pb-safe pt-2 flex justify-around items-center z-40">
      <button v-for="tab in ['home', 'itinerary', 'expense', 'info']" 
              :key="tab"
              @click="currentTab = tab"
              class="flex flex-col items-center gap-1 w-16 transition-all duration-200"
              :class="currentTab === tab ? 'text-blue-500 scale-105' : 'text-gray-400'">
         <i :class="[currentTab === tab ? 'ph-fill' : 'ph-bold', getTabIcon(tab)]" class="text-2xl"></i>
         <span class="text-[10px] font-medium capitalize">{{ t(tab) }}</span>
      </button>
    </nav>

  </div>

<script>
const { createApp, ref, computed, reactive, onMounted, watch, nextTick } = Vue;

createApp({
  setup() {
    // 1. Config
    const supabaseUrl = 'YOUR_SUPABASE_URL';
    const supabaseKey = 'YOUR_SUPABASE_KEY';
    let supabase = null;
    if (typeof window.supabase !== 'undefined' && supabaseUrl.startsWith('http')) {
        supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    }

    // 2. State
    const currentTab = ref('home');
    const activeSubPage = ref(null);
    const lang = ref(localStorage.getItem('ts_lang') || 'zh'); // Local
    const flightSkin = ref(localStorage.getItem('ts_skin') || 'ios'); // Local
    
    // Sync Data
    const settings = reactive({
        origin: 'HKG', destination: 'KIX',
        dateRange: { start: '2026-03-22', end: '2026-03-27' },
        weatherCity: 'Osaka',
        currency: { settle: 'HKD', local: 'JPY' }
    });

    const members = ref(['Me', 'Partner']); 
    const baseRate = ref(19.2); 
    const rateDisplayMode = ref('S_to_L');
    const isReturnFlight = ref(false);
    
    const flights = reactive({
        outbound: { code: 'CX506', airline: 'Cathay Pacific', time: '10:20', terminal: '1', gate: '28', status: 'On Time' },
        inbound:  { code: 'CX507', airline: 'Cathay Pacific', time: '18:00', terminal: '1', gate: '12', status: 'Boarding' }
    });

    const weather = reactive({
        temp: 18, icon: 'ph-sun', color: 'text-yellow-500', 
        feelsLike: 20, humidity: 45, uv: 3, wind: 12, precip: 0 
    });

    const itinerary = ref([]);
    const expenses = ref([]);
    const shoppingList = ref([]);
    const prepList = ref([{id:1, text:'Passport', done:false}]);
    const infoList = ref([]);

    // Editors
    const editingId = ref(null);
    const editingItem = ref({});
    const editingFlightType = ref('outbound');
    const editingExpense = reactive({ amount: 0, currency: 'HKD', category: 'food', payer: 'Me', method: 'card', item: '' });
    
    // Upload
    const isUploading = ref(false);
    const tempUploadPreview = ref(null);
    const fileInput = ref(null);

    // UI State
    const selectedDayIndex = ref(0);
    const showAddressCard = ref(false);
    const addressCardData = ref({ title:'', location:'' });
    const itineraryListRef = ref(null);
    const homePrepListRef = ref(null);

    // 3. i18n Dictionary
    const cities = { 'Seoul': '首爾', 'Osaka': '大阪', 'Tokyo': '東京', 'Taipei': '台北', 'London': '倫敦' };
    const i18n = {
        zh: {
            home:'首頁', itinerary:'行程', expense:'支出', info:'資訊', settings:'設定',
            back:'返回', appearance:'外觀', language:'語言', flightSkin:'機票樣式',
            tripData:'旅程資料', origin:'出發地', destination:'目的地', weatherCity:'天氣城市',
            resetData:'重置資料', cancel:'取消', save:'儲存', edit:'編輯', new:'新增', delete:'刪除',
            outbound:'去程', inbound:'回程', airline:'航空公司', time:'時間', terminal:'航廈', gate:'登機閘口', departure:'出發',
            settlement:'結算中心', paid:'已支付', total:'總計', payer:'付款人', method:'方式', cash:'現金', card:'信用卡',
            amount:'金額', itemName:'項目名稱', price:'價格', tapToUpload:'點擊上傳圖片',
            prepList:'準備清單', shoppingList:'購物清單', tripInfo:'旅程資訊', noActivity:'無行程',
            food:'餐飲', transport:'交通', shopping:'購物', ticket:'門票', stay:'住宿', other:'其他',
            add:'新增', title:'標題', locationAddr:'地點 / 地址', notes:'備註', editFlight:'編輯航班'
        },
        en: {
            home:'Home', itinerary:'Itinerary', expense:'Expense', info:'Info', settings:'Settings',
            back:'Back', appearance:'Appearance', language:'Language', flightSkin:'Flight Skin',
            tripData:'Trip Data', origin:'Origin', destination:'Dest', weatherCity:'City',
            resetData:'Reset Data', cancel:'Cancel', save:'Save', edit:'Edit', new:'New', delete:'Delete',
            outbound:'Outbound', inbound:'Inbound', airline:'Airline', time:'Time', terminal:'Term', gate:'Gate', departure:'Dep',
            settlement:'Settlement', paid:'Paid', total:'Total', payer:'Payer', method:'Method', cash:'Cash', card:'Card',
            amount:'Amount', itemName:'Item Name', price:'Price', tapToUpload:'Tap to Upload',
            prepList:'Prep List', shoppingList:'Shopping List', tripInfo:'Trip Info', noActivity:'No Activity',
            food:'Food', transport:'Transport', shopping:'Shop', ticket:'Ticket', stay:'Hotel', other:'Other',
            add:'Add', title:'Title', locationAddr:'Location', notes:'Notes', editFlight:'Edit Flight'
        }
    };

    // 4. Computed
    const t = (key) => i18n[lang.value][key] || key;
    const displayCity = computed(() => lang.value==='zh' ? (cities[settings.weatherCity] || settings.weatherCity) : settings.weatherCity);
    
    const activeFlight = computed(() => isReturnFlight.value ? flights.inbound : flights.outbound);
    const editingFlight = computed(() => editingFlightType.value === 'outbound' ? flights.outbound : flights.inbound);

    const formattedDateRange = computed(() => {
        if (!settings.dateRange.start) return '';
        const d1 = new Date(settings.dateRange.start);
        const d2 = new Date(settings.dateRange.end);
        return `${d1.getDate()} ${d1.toLocaleString('en', {month:'short'})} - ${d2.getDate()} ${d2.toLocaleString('en', {month:'short'})}`;
    });

    const tripDays = computed(() => {
        if (!settings.dateRange.start) return [];
        const start = new Date(settings.dateRange.start);
        const end = new Date(settings.dateRange.end);
        const diff = Math.ceil(Math.abs(end - start) / (86400000)) + 1;
        return Array.from({length: diff}, (_, i) => {
            let d = new Date(start); d.setDate(start.getDate() + i);
            return { 
                weekday: d.toLocaleString('en', {weekday:'short'}), 
                dateStr: `${d.getDate()} ${d.toLocaleString('en', {month:'short'})}`, 
                fullDate: d.toISOString().split('T')[0] 
            };
        });
    });

    const currentDayItinerary = computed(() => {
        const day = tripDays.value[selectedDayIndex.value];
        if(!day) return [];
        return itinerary.value.filter(i => i.date === day.fullDate || i.dayIndex === selectedDayIndex.value)
                              .sort((a,b) => a.time.localeCompare(b.time));
    });

    const totalExpense = computed(() => {
        let sum = expenses.value.reduce((s, e) => s + toSettle(e.amount, e.currency), 0);
        return { settle: sum, local: sum * baseRate.value };
    });
    const expensesBreakdown = computed(() => {
        let card = 0, cash = 0;
        expenses.value.forEach(e => {
            const val = toSettle(e.amount, e.currency);
            if(e.method === 'card') card += val; else cash += val;
        });
        return { card: { settle: card }, cash: { settle: cash } };
    });

    // 5. Methods
    const toggleLang = (l) => { lang.value = l || (lang.value==='zh'?'en':'zh'); localStorage.setItem('ts_lang', lang.value); };
    const saveLocalSettings = () => { localStorage.setItem('ts_skin', flightSkin.value); };
    const saveToCloud = (key, data) => { localStorage.setItem('ts_'+key, JSON.stringify(data)); /* Supabase Logic Hook */ };
    
    const openSubPage = (p) => { 
        activeSubPage.value = p; 
        if(p==='expenseEdit') { editingId.value=null; Object.assign(editingExpense, {amount:0, currency:settings.currency.local, category:'food', payer:'Me', method:'card'}); }
        if(p==='flightEdit') editingFlightType.value = isReturnFlight.value ? 'inbound' : 'outbound';
    };
    const closeSubPage = () => { activeSubPage.value=null; editingId.value=null; tempUploadPreview.value=null; };
    
    // Upload (Blob Fix)
    const triggerFileUpload = () => fileInput.value.click();
    const handleFileUpload = async (e) => {
        const file = e.target.files[0]; if(!file) return;
        isUploading.value = true;
        // Local Preview
        const reader = new FileReader();
        reader.onload = (ev) => {
            tempUploadPreview.value = ev.target.result;
            // Supabase Upload Logic (Pseudo)
            if(supabase) {
                // In real implementation: Convert Base64 to Blob -> Upload -> Get URL
                // Here we simulate success or fallback to local base64
                editingItem.value.image = ev.target.result; 
            } else {
                editingItem.value.image = ev.target.result;
            }
            isUploading.value = false;
        };
        reader.readAsDataURL(file);
    };

    // Generic CRUD
    const saveGenericItem = () => {
        const listMap = { itinerary: itinerary, shopping: shoppingList, prep: prepList, info: infoList };
        const list = listMap[activeSubPage.value];
        const item = { id: editingId.value || Date.now(), ...editingItem.value };
        
        if(activeSubPage.value === 'itinerary' && !item.date) {
            item.date = tripDays.value[item.dayIndex || selectedDayIndex.value].fullDate;
        }
        if(activeSubPage.value === 'shopping' && !item.price) delete item.price; // NaN Fix

        if(editingId.value) { const idx = list.value.findIndex(i=>i.id===editingId.value); list.value[idx] = item; }
        else list.value.push(item);
        
        saveToCloud(activeSubPage.value==='prep'?'prepList':(activeSubPage.value+'List'), list.value);
        closeSubPage();
    };
    
    const deleteItem = () => {
        if(!confirm('Delete?')) return;
        const listMap = { itinerary: itinerary, shopping: shoppingList, prep: prepList, info: infoList, expenseEdit: expenses };
        const k = activeSubPage.value === 'expenseEdit' ? 'expenseEdit' : activeSubPage.value;
        const list = listMap[k];
        list.value = list.value.filter(i => i.id !== editingId.value);
        saveToCloud('data', list.value); // Simplified
        closeSubPage();
    };

    // Itinerary & Prep
    const openItineraryAdd = () => { editingId.value=null; editingItem.value={dayIndex:selectedDayIndex.value, time:'10:00', title:''}; openSubPage('itinerary'); };
    const handleItineraryClick = (item) => { 
        if(item.location) {
            addressCardData.value = { title: item.title, location: item.location };
            showAddressCard.value = true;
        } else {
            editingId.value=item.id; editingItem.value={...item}; 
            const dIdx = tripDays.value.findIndex(d=>d.fullDate===item.date);
            editingItem.value.dayIndex = dIdx>=0?dIdx:0;
            openSubPage('itinerary');
        }
    };
    const togglePrep = (item) => { item.done=!item.done; saveToCloud('prepList', prepList.value); };
    const editPrep = (item) => { editingId.value=item.id; editingItem.value={...item}; openSubPage('prep'); };
    const editShopping = (item) => { editingId.value=item.id; editingItem.value={...item}; openSubPage('shopping'); };
    const editInfo = (item) => { editingId.value=item.id; editingItem.value={...item}; openSubPage('info'); };

    // Expense
    const saveExpense = () => {
        const item = { id: editingId.value || Date.now(), ...editingExpense, date: new Date().toISOString() };
        if(editingId.value) { const idx=expenses.value.findIndex(e=>e.id===editingId.value); expenses.value[idx]=item; }
        else expenses.value.unshift(item);
        saveToCloud('expenses', expenses.value); closeSubPage();
    };
    const editExpenseItem = (e) => { editingId.value=e.id; Object.assign(editingExpense, JSON.parse(JSON.stringify(e))); openSubPage('expenseEdit'); };
    const saveFlight = () => { saveToCloud('flights', flights); closeSubPage(); };

    // Helpers
    const formatNumber = (n) => new Intl.NumberFormat('en-US').format(n||0);
    const getRateDisplayValue = () => rateDisplayMode.value==='S_to_L' ? (baseRate.value/1.03).toFixed(4) : ((1/baseRate.value)*1.03).toFixed(4);
    const toggleRateMode = () => rateDisplayMode.value = rateDisplayMode.value==='S_to_L'?'L_to_S':'S_to_L';
    const toSettle = (amt, cur) => cur===settings.currency.settle ? amt : (amt/baseRate.value)*1.03;
    const getMemberPaid = (m) => expenses.value.filter(e=>e.payer===m).reduce((s,e)=>s+toSettle(e.amount,e.currency),0);
    const getCategoryIcon = (id) => ({food:'ph-hamburger', transport:'ph-train', shopping:'ph-shopping-bag', ticket:'ph-ticket', stay:'ph-bed', other:'ph-dots-three'}[id]);
    const formatDate = (d) => new Date(d).toLocaleDateString();
    const getTabIcon = (t) => ({home:'ph-house', itinerary:'ph-calendar-blank', expense:'ph-wallet', info:'ph-info'}[t]);
    const getStatusClass = (s) => s==='On Time'?'text-green-400':(s==='Delayed'?'text-red-400':'text-blue-400');
    const isInstagramLink = (l) => l && l.includes('instagram.com');
    const openLink = (l) => window.open(l, '_blank');
    const getGoogleMapUrl = (loc) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`;
    const getGoogleNavUrl = (loc) => `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(loc)}`;

    // Init & Watch
    onMounted(() => {
        const load = (k,r) => { const d=localStorage.getItem('ts_'+k); if(d) r.value=JSON.parse(d); };
        load('itinerary', itinerary); load('expenses', expenses); load('shoppingList', shoppingList); load('prepList', prepList); load('infoList', infoList);
        load('settings', settings); load('flights', flights);
        
        // Init Sortable
        nextTick(() => {
            if(itineraryListRef.value) Sortable.create(itineraryListRef.value, { animation: 150, handle: '.cal-stripe-item', onEnd: () => {/* Reorder logic */} });
            if(homePrepListRef.value) Sortable.create(homePrepListRef.value, { animation: 150 });
        });
    });

    return {
        currentTab, activeSubPage, lang, flightSkin, settings, members, baseRate, rateDisplayMode,
        flights, weather, itinerary, expenses, shoppingList, prepList, infoList,
        editingId, editingItem, editingExpense, editingFlightType, isReturnFlight,
        isUploading, tempUploadPreview, fileInput,
        tripDays, selectedDayIndex, currentDayItinerary, showAddressCard, addressCardData, itineraryListRef, homePrepListRef,
        t, displayCity, activeFlight, editingFlight, totalExpense, expensesBreakdown, formattedDateRange, expenseCats: [{id:'food'},{id:'transport'},{id:'shopping'},{id:'ticket'},{id:'stay'},{id:'other'}],
        toggleLang, saveLocalSettings, saveToCloud, openSubPage, closeSubPage,
        triggerFileUpload, handleFileUpload, saveGenericItem, deleteItem,
        openItineraryAdd, handleItineraryClick, togglePrep, editPrep, editShopping, editInfo,
        saveExpense, editExpenseItem, saveFlight, formatNumber, getRateDisplayValue, toggleRateMode, toSettle, getMemberPaid, getCategoryIcon, formatDate, getTabIcon, getStatusClass, isInstagramLink, openLink, getGoogleMapUrl, getGoogleNavUrl,
        resetData: () => { if(confirm('Reset?')) { localStorage.clear(); location.reload(); } }
    };
  }
}).mount('#app');
</script>
</body>
</html>
