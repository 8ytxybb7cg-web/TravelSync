<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Travel Sync Ultimate</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    :root {
      --ios-bg: #F2F2F7;
      --ios-card-bg: rgba(255, 255, 255, 0.7);
      --glass-blur: 20px;
      --ios-primary: #007AFF;
    }
    body { background: var(--ios-bg); font-family: -apple-system, system-ui, sans-serif; overflow-x: hidden; }
    .ios-blur { backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur)); }
    .ios-card { background: var(--ios-card-bg); border-radius: 18px; border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 80px); }
    .no-scroll { overflow: hidden; }
    .drag-handle { cursor: grab; }
    /* HKG Skin */
    .skin-hkg { background: #000 !important; color: #fff !important; }
    .skin-hkg .ios-card { background: #1c1c1e !important; border-color: #333 !important; color: #fff !important; }
  </style>
</head>
<body>
  <div id="app" :class="{'skin-hkg': flightCardSkin === 'hkg'}">
    
    <nav class="fixed top-0 left-0 right-0 z-50 ios-blur bg-white/70 border-b border-gray-200 px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <span class="w-2 h-2 rounded-full" :class="syncState === 'synced' ? 'bg-green-500' : 'bg-orange-500'"></span>
        <h1 class="font-bold text-lg">Travel Sync</h1>
      </div>
      <button @click="toggleLang" class="text-sm font-medium px-3 py-1 rounded-full bg-gray-100 uppercase">{{ lang }}</button>
    </nav>

    <main class="pt-20 px-4 safe-bottom">
      
      <div v-if="currentTab === 'home'" class="space-y-6">
        <div class="ios-card p-5 relative overflow-hidden">
          <div class="flex justify-between items-start mb-6">
            <button @click="toggleSkin" class="text-xs bg-gray-200/50 px-2 py-1 rounded">{{ flightCardSkin === 'ios' ? 'Skin: iOS' : 'Skin: HKG' }}</button>
            <div class="text-right">
              <div class="text-2xl font-black italic tracking-tighter">{{ activeFlight.number }}</div>
              <div class="text-[10px] opacity-60 uppercase">Status: Confirmed</div>
            </div>
          </div>
          <div class="flex justify-between items-center mb-8">
            <div class="text-center">
              <div class="text-4xl font-bold tracking-tighter">HKG</div>
              <div class="text-xs opacity-50">{{ activeFlight.depTime }}</div>
            </div>
            <i class="ph-fill ph-airplane-tilt text-2xl text-blue-500"></i>
            <div class="text-center">
              <div class="text-4xl font-bold tracking-tighter">KIX</div>
              <div class="text-xs opacity-50">{{ activeFlight.arrTime }}</div>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-2 text-center text-sm border-t border-gray-100 pt-4">
            <div><div class="opacity-50 text-[10px]">GATE</div><div class="font-bold">--</div></div>
            <div><div class="opacity-50 text-[10px]">SEAT</div><div class="font-bold">{{ activeFlight.seat }}</div></div>
            <div><div class="opacity-50 text-[10px]">CLASS</div><div class="font-bold">Y</div></div>
          </div>
        </div>

        <section>
          <h2 class="text-sm font-semibold mb-3 px-1 text-gray-500">準備清單 (可拖拽排序)</h2>
          <div id="sortable-pre-notes" class="space-y-2">
            <div v-for="(note, idx) in preTripNotes" :key="idx" class="ios-card p-3 flex items-center gap-3">
              <i class="ph ph-dots-six-vertical drag-handle text-gray-400"></i>
              <input type="checkbox" v-model="note.done" @change="saveAll" class="w-5 h-5 rounded-full">
              <span :class="{'line-through opacity-40': note.done}" class="flex-1">{{ note.text }}</span>
            </div>
          </div>
        </section>

        <section>
          <h2 class="text-sm font-semibold mb-3 px-1 text-gray-500">購物清單</h2>
          <div id="sortable-shopping" class="space-y-2">
            <div v-for="(item, idx) in shoppingList" :key="idx" class="ios-card p-3 flex items-center gap-3">
              <i class="ph ph-dots-six-vertical drag-handle text-gray-400"></i>
              <span class="flex-1">{{ item.name }}</span>
              <span class="text-xs text-blue-500">¥{{ item.price }}</span>
            </div>
          </div>
        </section>
      </div>

      <div v-if="currentTab === 'expense'" class="space-y-4">
        <div class="ios-card p-5 bg-blue-600 text-white">
          <div class="text-xs opacity-80">總支出 (HKD)</div>
          <div class="text-3xl font-bold">${{ totalExpense }}</div>
        </div>
        
        <div id="sortable-expenses" class="space-y-2">
          <div v-for="(exp, idx) in expenses" :key="idx" class="ios-card p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <i class="ph ph-dots-six-vertical drag-handle text-gray-400"></i>
              <div>
                <div class="font-bold">{{ exp.item }}</div>
                <div class="text-xs opacity-50">{{ exp.category }}</div>
              </div>
            </div>
            <div class="text-right">
              <div class="font-bold text-red-500">-¥{{ exp.amount }}</div>
            </div>
          </div>
        </div>
      </div>

      <div v-if="currentTab === 'itinerary'">行程頁面開發中...</div>
      <div v-if="currentTab === 'settings'">設定頁面開發中...</div>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 ios-blur bg-white/80 border-t border-gray-200 flex justify-around py-3 px-2 z-50">
      <button @click="currentTab = 'home'" :class="currentTab === 'home' ? 'text-blue-600' : 'text-gray-400'" class="flex flex-col items-center">
        <i class="ph-fill ph-house text-2xl"></i><span class="text-[10px] mt-1">首頁</span>
      </button>
      <button @click="currentTab = 'itinerary'" :class="currentTab === 'itinerary' ? 'text-blue-600' : 'text-gray-400'" class="flex flex-col items-center">
        <i class="ph-fill ph-calendar text-2xl"></i><span class="text-[10px] mt-1">行程</span>
      </button>
      <button @click="currentTab = 'expense'" :class="currentTab === 'expense' ? 'text-blue-600' : 'text-gray-400'" class="flex flex-col items-center">
        <i class="ph-fill ph-wallet text-2xl"></i><span class="text-[10px] mt-1">記帳</span>
      </button>
      <button @click="currentTab = 'settings'" :class="currentTab === 'settings' ? 'text-blue-600' : 'text-gray-400'" class="flex flex-col items-center">
        <i class="ph-fill ph-gear-six text-2xl"></i><span class="text-[10px] mt-1">設定</span>
      </button>
    </nav>

  </div>

  <script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
      setup() {
        // --- 設定 ---
        const SUPABASE_URL = 'https://myrhatzdypiwwgmmfbuw.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_bnnah-2fsCaQnKZDoKNJQw_NuYQVvKi';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 狀態 ---
        const currentTab = ref('home');
        const lang = ref('zh');
        const flightCardSkin = ref(localStorage.getItem('skin') || 'ios');
        const syncState = ref('synced');
        
        // --- 資料數據 (範例) ---
        const preTripNotes = ref([{text: '帶護照', done: false}, {text: '換日幣', done: true}]);
        const shoppingList = ref([{name: '藥妝', price: 5000}]);
        const expenses = ref([{item: '拉麵', amount: 1200, category: '餐飲', order_index: 0}]);
        const activeFlight = ref({number: 'CX506', depTime: '10:20', arrTime: '15:10', seat: '12A'});

        // --- 功能函數 ---
        const toggleSkin = () => {
          flightCardSkin.value = flightCardSkin.value === 'ios' ? 'hkg' : 'ios';
          localStorage.setItem('skin', flightCardSkin.value);
        };
        const toggleLang = () => lang.value = lang.value === 'zh' ? 'en' : 'zh';

        const saveAll = async () => {
          syncState.value = 'syncing';
          // 這裡模擬上傳到 Supabase
          console.log("Saving data to Supabase...");
          setTimeout(() => syncState.value = 'synced', 800);
        };

        // --- 通用 Sortable 初始化函數 (回答你的疑問) ---
        const initSortable = (id, listRef, isExpense = false) => {
          const el = document.getElementById(id);
          if (!el) return;
          new Sortable(el, {
            handle: '.drag-handle',
            animation: 150,
            onEnd: (evt) => {
              const item = listRef.value.splice(evt.oldIndex, 1)[0];
              listRef.value.splice(evt.newIndex, 0, item);
              if (isExpense) {
                listRef.value.forEach((x, i) => x.order_index = i);
              }
              saveAll();
            }
          });
        };

        // --- 核心：監聽分頁切換並重新綁定拖曳功能 ---
        watch(currentTab, (newTab) => {
          nextTick(() => {
            if (newTab === 'home') {
              initSortable('sortable-pre-notes', preTripNotes);
              initSortable('sortable-shopping', shoppingList);
            } else if (newTab === 'expense') {
              initSortable('sortable-expenses', expenses, true);
            }
          });
        });

        onMounted(() => {
          // 初始載入
          nextTick(() => {
            initSortable('sortable-pre-notes', preTripNotes);
            initSortable('sortable-shopping', shoppingList);
          });
        });

        return {
          currentTab, lang, flightCardSkin, syncState,
          preTripNotes, shoppingList, expenses, activeFlight,
          toggleSkin, toggleLang, saveAll,
          totalExpense: computed(() => expenses.value.reduce((s, e) => s + e.amount, 0))
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
