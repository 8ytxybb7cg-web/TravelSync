<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="theme-color" content="#F2F2F7" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#1c1c1e" media="(prefers-color-scheme: dark)">
  <title>Travel Sync Ultimate (v251229-7.03)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    /* --- 1. Variables & Base --- */
    :root {
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      --ios-bg: #F2F2F7;
      --hkg-red: #C8102E;
      --glass-dark: rgba(30, 30, 30, 0.6);
    }
    body {
      font-family: var(--font-stack);
      background-color: var(--ios-bg);
      margin: 0; padding-bottom: 100px;
      user-select: none; -webkit-user-select: none;
      touch-action: pan-y;
      color: #1c1c1e;
      overflow-x: hidden;
    }
    
    /* Background Layer */
    .bg-layer { position: fixed; inset: 0; z-index: -1; pointer-events: none; }

    /* Utilities */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom) + 20px); }
    .pt-safe { padding-top: calc(env(safe-area-inset-top) + 10px); }
    [v-cloak] { display: none; }

    /* --- 2. 7.02/6.02 Card Systems --- */
    .ios-card {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      overflow: hidden;
    }

    /* 5.09 Dark Glass Style (For Expense) */
    .ios-card-dark-glass {
        background: rgba(28, 28, 30, 0.85);
        backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        position: relative; overflow: hidden;
        box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        color: white;
    }
    .dark-glass-gradient {
        position: absolute; top: 0; left: 0; right: 0; height: 150px;
        background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
        pointer-events: none;
    }

    /* Flight Card Skins */
    .flight-card-base {
        border-radius: 20px; min-height: 220px;
        position: relative; overflow: hidden;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        display: flex; flex-direction: column;
        transition: all 0.3s ease;
    }
    .skin-ios {
        background: rgba(20, 20, 25, 0.85);
        border: 1px solid rgba(255,255,255,0.1); color: white;
        backdrop-filter: blur(30px);
    }
    .skin-ios .status-badge {
        background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 8px;
        font-size: 11px; font-weight: 700; letter-spacing: 1px;
    }
    .skin-hkg {
        background: #FFFFFF; border: 1px solid rgba(0,0,0,0.05); color: black;
    }
    .hkg-footer {
        background: #C8102E; color: white; padding: 14px 20px; margin-top: auto;
        display: flex; justify-content: space-between; align-items: center;
    }

    /* --- 3. Lists & Itinerary (6.02 Style) --- */
    .cal-stripe-item {
        background: white; border-radius: 16px;
        padding: 12px 16px; margin-bottom: 12px;
        display: flex; align-items: center; gap: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        border: 1px solid rgba(0,0,0,0.03);
        position: relative; overflow: hidden;
    }
    .item-time-box {
        min-width: 55px; text-align: center;
        border-right: 1px solid #F2F2F7; padding-right: 12px;
        display: flex; flex-direction: column; justify-content: center;
    }
    .item-time-main {
        font-size: 17px; font-weight: 800; color: #1c1c1e;
        line-height: 1; font-variant-numeric: tabular-nums;
    }
    .item-time-sub {
        font-size: 10px; font-weight: 700; color: #8E8E93;
        text-transform: uppercase; margin-top: 3px;
    }
    
    /* Prep List */
    .prep-item {
        background: rgba(255,255,255,0.8);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding: 14px 16px; display: flex; align-items: center; gap: 12px;
    }
    .prep-item.done span { text-decoration: line-through; color: #999; }
    
    /* 5.09 Calculator & Modal Styles */
    .calc-btn {
        height: 60px; border-radius: 16px; font-size: 22px; font-weight: 600;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.1s;
    }
    .calc-btn:active { transform: scale(0.95); }
    .calc-num { background: rgba(255,255,255,0.05); color: white; }
    .calc-op { background: #FF9F0A; color: white; }
    .calc-action { background: rgba(255,255,255,0.15); color: black; }
    
    .modal-overlay {
        position: fixed; inset: 0; z-index: 100;
        background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
        display: flex; flex-col; justify-content: flex-end;
    }
    .modal-content {
        background: #1C1C1E; border-top-left-radius: 24px; border-top-right-radius: 24px;
        padding: 20px; color: white; width: 100%; padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
    }
    
    /* 5.09 Address Popup */
    .address-popup {
        position: fixed; top: 0; left: 0; width: 100%; z-index: 100;
        background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
        padding: 60px 20px 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        transform: translateY(-100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .address-popup.active { transform: translateY(0); }
    
    /* Transitions */
    .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease; }
    .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
  </style>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const { createApp, ref, computed, reactive, onMounted, watch, nextTick } = Vue;

      createApp({
        setup() {
          // --- 1. System & Config ---
          const supabaseUrl = 'YOUR_SUPABASE_URL';
          const supabaseKey = 'YOUR_SUPABASE_KEY';
          let supabase = null;
          if (typeof window.supabase !== 'undefined' && supabaseUrl.startsWith('http')) {
              supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
          }

          // --- 2. State (Merged) ---
          const currentTab = ref('home');
          const activeSubPage = ref(null);
          const lang = ref(localStorage.getItem('ts_lang') || 'zh');
          const flightSkin = ref(localStorage.getItem('ts_skin') || 'ios');
          
          // Settings
          const settings = reactive({
              origin: 'HKG', destination: 'KIX',
              dateRange: { start: '2026-03-22', end: '2026-03-27' },
              weatherCity: 'Osaka',
              currency: { settle: 'HKD', local: 'JPY' }
          });
          const baseRate = ref(19.2); // Settle to Local rate
          const rateDisplayMode = ref('S_to_L');
          
          // Data Containers
          const members = ref(['Me', 'Partner']);
          const expenses = ref([]);
          const itinerary = ref([]);
          const shoppingList = ref([]);
          const prepList = ref([{id:1, text:'Passport', done:false}]);
          const infoList = ref([]);
          const flights = reactive({
              outbound: { code: 'CX506', airline: 'Cathay Pacific', time: '10:20', terminal: '1', gate: '28', status: 'On Time' },
              inbound:  { code: 'CX507', airline: 'Cathay Pacific', time: '18:00', terminal: '1', gate: '12', status: 'Boarding' }
          });
          const weather = reactive({ temp: 18, icon: 'ph-sun', color: 'text-yellow-500', feelsLike: 20, humidity: 45, uv: 3, wind: 12, precip: 0 });

          // UI State
          const isReturnFlight = ref(false);
          const selectedDayIndex = ref(0);
          const showAddressCard = ref(false);
          const addressCardData = ref({ title:'', location:'' });
          const showExpenseModal = ref(false);
          const showMemberModal = ref(false);
          const expenseFilter = ref('all'); // all, credit, cash, settlement

          // Editing State
          const editingId = ref(null);
          const editingItem = ref({});
          const editingFlightType = ref('outbound');
          
          // 5.09 Calculator State
          const calcDisplay = ref('0');
          const tempAmount = ref(0);
          const editingExpense = reactive({
              id: null, date: '', category: 'food', name: '',
              amount: 0, currency: 'HKD', exchangeRate: 1,
              paymentMethod: 'credit_card', payer: 'Me', involved: []
          });

          // Upload
          const isUploading = ref(false);
          const tempUploadPreview = ref(null);
          const fileInput = ref(null);
          
          // Refs for Sortable
          const itineraryListRef = ref(null);
          const homePrepListRef = ref(null);

          // i18n
          const cities = { 'Seoul': '首爾', 'Osaka': '大阪', 'Tokyo': '東京', 'Taipei': '台北', 'London': '倫敦' };
          const i18n = {
              zh: {
                  home:'首頁', itinerary:'行程', expense:'記帳', info:'資訊', settings:'設定', noActivity:'無行程',
                  outbound:'去程', inbound:'回程', terminal:'航廈', gate:'登機閘口', departure:'出發',
                  food:'餐飲', transport:'交通', shopping:'購物', ticket:'門票', stay:'住宿', other:'其他',
                  tapToUpload:'點擊上傳', itemName:'項目名稱', price:'價格', save:'儲存', delete:'刪除'
              },
              en: {
                  home:'Home', itinerary:'Itinerary', expense:'Accounting', info:'Info', settings:'Settings', noActivity:'No Activity',
                  outbound:'Outbound', inbound:'Inbound', terminal:'Term', gate:'Gate', departure:'Dep',
                  food:'Food', transport:'Transport', shopping:'Shop', ticket:'Ticket', stay:'Hotel', other:'Other',
                  tapToUpload:'Tap to Upload', itemName:'Item Name', price:'Price', save:'Save', delete:'Delete'
              }
          };

          // --- 3. Computed Logic ---
          const t = (key) => i18n[lang.value][key] || key;
          const displayCity = computed(() => lang.value==='zh' ? (cities[settings.weatherCity] || settings.weatherCity) : settings.weatherCity);
          const activeFlight = computed(() => isReturnFlight.value ? flights.inbound : flights.outbound);
          
          // Date & Trip Days
          const tripDays = computed(() => {
              if (!settings.dateRange.start) return [];
              const start = new Date(settings.dateRange.start);
              const end = new Date(settings.dateRange.end);
              const diff = Math.ceil(Math.abs(end - start) / (86400000)) + 1;
              return Array.from({length: diff}, (_, i) => {
                  let d = new Date(start); d.setDate(start.getDate() + i);
                  return { 
                      weekday: d.toLocaleString('en', {weekday:'short'}), 
                      dateStr: `${d.getDate()} ${d.toLocaleString('en', {month:'short'})}`, 
                      fullDate: d.toISOString().split('T')[0] 
                  };
              });
          });

          const currentDayItinerary = computed(() => {
              const day = tripDays.value[selectedDayIndex.value];
              if(!day) return [];
              return itinerary.value.filter(i => i.date === day.fullDate || i.dayIndex === selectedDayIndex.value)
                                    .sort((a,b) => a.time.localeCompare(b.time));
          });

          // --- 5.09 Expense Logic (Ported) ---
          const totalExpense = computed(() => {
              // Convert everything to Settle Currency (e.g., HKD)
              const sum = (filterFn) => expenses.value.filter(filterFn).reduce((acc, e) => {
                  const amt = e.currency === settings.currency.settle ? e.amount : (e.amount / e.exchangeRate);
                  return acc + amt;
              }, 0);

              const all = sum(() => true);
              const credit = sum(e => e.paymentMethod === 'credit_card');
              const cash = sum(e => e.paymentMethod === 'cash');

              return {
                  hkd: all, // Main Settle Currency
                  twd: all * baseRate.value, // Est. Local Currency
                  creditHkd: credit, creditTwd: credit * baseRate.value,
                  cashHkd: cash, cashTwd: cash * baseRate.value
              };
          });

          const filteredExpenses = computed(() => {
              let list = [...expenses.value];
              if (expenseFilter.value === 'credit') list = list.filter(e => e.paymentMethod === 'credit_card');
              if (expenseFilter.value === 'cash') list = list.filter(e => e.paymentMethod === 'cash');
              return list.sort((a,b) => new Date(b.date) - new Date(a.date));
          });

          const settlementList = computed(() => {
              let balances = {};
              members.value.forEach(m => balances[m] = 0);
              expenses.value.forEach(e => {
                  const amt = e.currency === settings.currency.settle ? e.amount : (e.amount / e.exchangeRate);
                  // Payer pays positive
                  balances[e.payer] = (balances[e.payer] || 0) + amt;
                  // Involved subtracts
                  const involvedList = (e.involved && e.involved.length > 0) ? e.involved : members.value;
                  const splitAmt = amt / involvedList.length;
                  involvedList.forEach(m => {
                      balances[m] = (balances[m] || 0) - splitAmt;
                  });
              });
              return Object.keys(balances).map(name => ({ name, amount: balances[name] })).sort((a,b) => b.amount - a.amount);
          });
          
          const settlementStatus = computed(() => ({ hasData: expenses.value.length > 0 }));

          // --- 4. Methods ---
          // General
          const saveToCloud = (key, data) => { localStorage.setItem('ts_'+key, JSON.stringify(data)); };
          const toggleLang = () => { lang.value = lang.value==='zh'?'en':'zh'; localStorage.setItem('ts_lang', lang.value); };
          const formatNumber = (n, d=0) => new Intl.NumberFormat('en-US', {minimumFractionDigits:d, maximumFractionDigits:d}).format(n||0);
          const getRateDisplayValue = () => rateDisplayMode.value==='S_to_L' ? (baseRate.value).toFixed(4) : (1/baseRate.value).toFixed(4);
          
          // Expense Modal Logic (5.09)
          const openExpenseModal = (existing) => {
              if (existing) {
                  Object.assign(editingExpense, JSON.parse(JSON.stringify(existing)));
                  calcDisplay.value = existing.amount.toString();
              } else {
                  Object.assign(editingExpense, {
                      id: null, date: new Date().toISOString().split('T')[0],
                      category: 'food', name: '', amount: 0,
                      currency: settings.currency.local, exchangeRate: baseRate.value,
                      paymentMethod: 'credit_card', payer: members.value[0], involved: []
                  });
                  calcDisplay.value = '0';
              }
              showExpenseModal.value = true;
          };
          
          const handleCalcInput = (v) => {
              if (v === 'C') { calcDisplay.value = '0'; return; }
              if (v === 'back') { calcDisplay.value = calcDisplay.value.length > 1 ? calcDisplay.value.slice(0,-1) : '0'; return; }
              const ops = ['+','-','*','/'];
              if (ops.includes(v)) { calcDisplay.value += v; return; }
              if (calcDisplay.value === '0' && v !== '.') calcDisplay.value = v;
              else calcDisplay.value += v;
          };

          const saveExpenseResult = () => {
              try {
                  const res = eval(calcDisplay.value) || 0;
                  editingExpense.amount = parseFloat(res.toFixed(2));
                  const newRecord = { ...editingExpense, id: editingExpense.id || Date.now() };
                  
                  if (editingExpense.id) {
                      const idx = expenses.value.findIndex(e => e.id === editingExpense.id);
                      if(idx !== -1) expenses.value[idx] = newRecord;
                  } else {
                      expenses.value.unshift(newRecord);
                  }
                  saveToCloud('expenses', expenses.value);
                  showExpenseModal.value = false;
              } catch (e) { alert('Calculator Error'); }
          };
          
          const removeExpense = (id) => {
              if(confirm('Delete?')) {
                  expenses.value = expenses.value.filter(e => e.id !== id);
                  saveToCloud('expenses', expenses.value);
                  showExpenseModal.value = false;
              }
          };

          // Members Logic
          const openMemberModal = () => { showMemberModal.value = true; };
          const addMember = () => { const n = prompt('Name:'); if(n && !members.value.includes(n)) members.value.push(n); saveToCloud('settings', settings); }; // Simplified save
          const removeMember = (m) => { if(confirm('Remove?')) members.value = members.value.filter(x => x !== m); saveToCloud('settings', settings); };
          const toggleInvolved = (m) => {
              const idx = editingExpense.involved.indexOf(m);
              if (idx > -1) editingExpense.involved.splice(idx, 1);
              else editingExpense.involved.push(m);
          };

          // Generic Tab / SubPage
          const openSubPage = (p) => { activeSubPage.value = p; editingId.value = null; };
          const closeSubPage = () => { activeSubPage.value = null; editingId.value = null; };
          const getCategoryIcon = (c) => ({food:'ph-hamburger', transport:'ph-train', shopping:'ph-shopping-bag', ticket:'ph-ticket', stay:'ph-bed', other:'ph-dots-three'}[c] || 'ph-star');
          const isInstagramLink = (l) => l && l.includes('instagram.com');
          const openLink = (l) => window.open(l, '_blank');
          
          // Itinerary Actions
          const openItineraryAdd = () => { editingId.value=null; editingItem.value={dayIndex:selectedDayIndex.value, time:'10:00', title:''}; openSubPage('itinerary'); };
          const handleItineraryClick = (item) => { 
             if(item.location) { addressCardData.value = {title:item.title, location:item.location}; showAddressCard.value=true; }
             else { editingId.value=item.id; editingItem.value={...item}; openSubPage('itinerary'); }
          };
          
          // Generic Save/Delete (Shopping/Itinerary/Prep)
          const saveGenericItem = () => {
             const listMap = { itinerary: itinerary, shopping: shoppingList, prep: prepList, info: infoList };
             const list = listMap[activeSubPage.value];
             const item = { id: editingId.value || Date.now(), ...editingItem.value };
             if(activeSubPage.value==='itinerary' && !item.date) item.date = tripDays.value[item.dayIndex||selectedDayIndex.value].fullDate;
             if(editingId.value) { const idx=list.value.findIndex(i=>i.id===editingId.value); list.value[idx]=item; }
             else list.value.push(item);
             saveToCloud(activeSubPage.value+'List', list.value); closeSubPage();
          };
          const deleteItem = () => { if(confirm('Del?')) { 
             const listMap = { itinerary: itinerary, shopping: shoppingList, prep: prepList, info: infoList };
             const list = listMap[activeSubPage.value];
             list.value = list.value.filter(i=>i.id!==editingId.value);
             saveToCloud(activeSubPage.value+'List', list.value); closeSubPage();
          }};

          // Init
          onMounted(() => {
             const load = (k,r) => { const d=localStorage.getItem('ts_'+k); if(d) r.value=JSON.parse(d); };
             load('itinerary', itinerary); load('expenses', expenses); load('shoppingList', shoppingList); load('prepList', prepList); load('infoList', infoList);
             load('settings', settings); load('flights', flights);
             
             // Setup Sortable
             nextTick(() => {
                 if(itineraryListRef.value) Sortable.create(itineraryListRef.value, { animation: 150, handle: '.cal-stripe-item' });
                 if(homePrepListRef.value) Sortable.create(homePrepListRef.value, { animation: 150 });
             });
          });

          return {
             // State
             currentTab, activeSubPage, lang, flightSkin, settings, members, baseRate, rateDisplayMode,
             flights, weather, itinerary, expenses, shoppingList, prepList, infoList,
             editingId, editingItem, editingFlightType, isReturnFlight,
             // Expense Specific
             totalExpense, filteredExpenses, settlementList, settlementStatus, expenseFilter,
             showExpenseModal, showMemberModal, editingExpense, calcDisplay,
             // UI
             tripDays, selectedDayIndex, currentDayItinerary, showAddressCard, addressCardData, itineraryListRef, homePrepListRef,
             isUploading, tempUploadPreview, fileInput,
             // Methods
             t, displayCity, activeFlight, formatNumber, getCategoryIcon, isInstagramLink, openLink,
             toggleLang, openSubPage, closeSubPage, saveToCloud,
             openItineraryAdd, handleItineraryClick, saveGenericItem, deleteItem,
             // Expense Methods
             openExpenseModal, handleCalcInput, saveExpenseResult, removeExpense, 
             openMemberModal, addMember, removeMember, toggleInvolved
          };
        }
      }).mount('#app'); // Note: Part 2 will provide the HTML #app content
    });
  </script>
</head>
<body>
  
  <div class="bg-layer">
      <img src="./IMG_7005.jpeg" 
           class="w-full h-full object-cover blur-[4px] scale-105" 
           alt="Background">
      <div class="absolute inset-0 bg-white/70 backdrop-blur-[2px]"></div>
  </div>

  <div id="app" class="h-full flex flex-col relative" v-cloak>
    
    <div class="address-popup" :class="{ 'active': showAddressCard }">
       <div class="flex justify-between items-start mb-2">
          <h3 class="font-bold text-lg text-gray-800">{{ addressCardData.title }}</h3>
          <button @click="showAddressCard = false" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
             <i class="ph-bold ph-x text-gray-500"></i>
          </button>
       </div>
       <div class="text-sm text-gray-500 mb-4 flex items-center gap-1">
          <i class="ph-fill ph-map-pin text-red-500"></i>
          {{ addressCardData.location }}
       </div>
       <div class="grid grid-cols-2 gap-3">
          <a :href="`https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(addressCardData.location)}`" target="_blank" class="py-3 bg-gray-100 rounded-xl font-bold text-gray-700 flex items-center justify-center gap-2">
             <i class="ph-bold ph-map-trifold"></i> Map
          </a>
          <a :href="`https://www.google.com/maps/dir/?api=1&destination=$${encodeURIComponent(addressCardData.location)}`" target="_blank" class="py-3 bg-blue-500 rounded-xl font-bold text-white flex items-center justify-center gap-2">
             <i class="ph-bold ph-navigation-arrow"></i> GO
          </a>
       </div>
    </div>

    <main v-if="currentTab === 'home'" class="flex-1 overflow-y-auto overflow-x-hidden pb-32 no-scrollbar">
      
      <header class="pt-safe px-5 pb-2 flex justify-between items-start z-10 sticky top-0 bg-white/50 backdrop-blur-md transition-all">
        <div class="flex flex-col pt-1">
           <span class="text-[11px] font-semibold text-gray-500 tracking-wide uppercase mb-0.5">
             {{ tripDays.length > 0 ? `${tripDays[0].dateStr} - ${tripDays[tripDays.length-1].dateStr}` : 'No Date' }}
           </span>
           <div class="flex items-center gap-2">
             <h1 class="text-3xl font-black tracking-tight flex items-center gap-2 text-black">
               {{ settings.origin.toUpperCase() }} 
               <span class="text-blue-500 text-2xl">✈️</span>
               {{ settings.destination.toUpperCase() }}
             </h1>
           </div>
        </div>
        <div class="flex flex-col items-end pt-1">
           <button @click="toggleLang" class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center active:scale-90 transition-transform border border-gray-100">
             <span class="text-xs font-bold text-gray-600">{{ lang === 'zh' ? 'EN' : '中' }}</span>
           </button>
           <button @click="openSubPage('settings')" class="w-10 h-10 mt-2 rounded-full bg-white shadow-sm flex items-center justify-center active:scale-90 transition-transform border border-gray-100">
             <i class="ph-fill ph-gear text-lg text-gray-600"></i>
           </button>
        </div>
      </header>

      <div class="px-5 space-y-6 mt-2">

        <div class="relative group">
           <button @click="openSubPage('flightEdit')" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-black/10 flex items-center justify-center text-white backdrop-blur-md hover:bg-black/30 transition-all">
              <i class="ph-fill ph-pencil-simple text-sm"></i>
           </button>

           <div v-if="flightSkin === 'hkg'" class="flight-card-base skin-hkg">
               <div class="p-5 flex-1 relative">
                  <div class="flex justify-between items-start">
                      <div class="flex items-center gap-2">
                         <i class="ph-fill ph-airplane-tilt text-red-600 text-xl"></i>
                         <span class="font-bold text-gray-800 tracking-tight">{{ activeFlight.airline }}</span>
                      </div>
                      <span class="font-mono font-bold text-gray-400">{{ activeFlight.code }}</span>
                  </div>
                  <div class="mt-4 flex justify-between items-end">
                      <div class="text-center">
                          <div class="text-4xl font-black text-gray-900">{{ activeFlight.time }}</div>
                          <div class="text-xs text-gray-400 mt-1 uppercase tracking-wider font-bold">{{ t('departure') }}</div>
                      </div>
                      <div class="pb-2"><i class="ph-duotone ph-arrow-right text-gray-300 text-2xl"></i></div>
                  </div>
                  <div class="mt-4 text-center">
                      <div class="text-[10px] text-gray-400 font-bold uppercase tracking-[2px]">{{ t('gate') }}</div>
                      <div class="text-6xl font-black text-gray-900 leading-none tracking-tighter">{{ activeFlight.gate }}</div>
                  </div>
               </div>
               <div class="hkg-footer">
                   <div>
                       <div class="text-[9px] opacity-80 font-bold uppercase">{{ t('terminal') }}</div>
                       <div class="text-xl font-bold">{{ activeFlight.terminal }}</div>
                   </div>
                   <div class="text-right">
                       <span class="px-2 py-0.5 bg-white/20 rounded text-[10px] font-bold uppercase tracking-wider">{{ activeFlight.status }}</span>
                   </div>
               </div>
               <div class="absolute top-[18px] left-0 w-full flex justify-center pointer-events-none">
                  <div class="bg-gray-100 rounded-lg p-0.5 flex pointer-events-auto shadow-inner">
                     <button @click="isReturnFlight=false" :class="!isReturnFlight?'bg-white shadow text-red-600':'text-gray-400'" class="px-3 py-1 text-[9px] font-bold rounded-md transition-all">OUT</button>
                     <button @click="isReturnFlight=true" :class="isReturnFlight?'bg-white shadow text-red-600':'text-gray-400'" class="px-3 py-1 text-[9px] font-bold rounded-md transition-all">IN</button>
                  </div>
               </div>
           </div>

           <div v-else class="flight-card-base skin-ios p-6 flex flex-col justify-between">
               <div class="flex justify-center mb-2">
                  <div class="bg-white/10 p-0.5 rounded-lg flex backdrop-blur-md">
                     <button @click="isReturnFlight=false" :class="!isReturnFlight?'bg-white/20 text-white':'text-white/40'" class="px-3 py-1 text-[10px] font-bold rounded-md transition-all">OUTBOUND</button>
                     <button @click="isReturnFlight=true" :class="isReturnFlight?'bg-white/20 text-white':'text-white/40'" class="px-3 py-1 text-[10px] font-bold rounded-md transition-all">INBOUND</button>
                  </div>
               </div>
               <div class="flex justify-between items-end">
                   <div>
                       <div class="text-4xl font-bold tracking-tight">{{ activeFlight.code }}</div>
                       <div class="text-xs text-blue-300 font-medium mt-1">{{ activeFlight.airline }}</div>
                   </div>
                   <div class="text-right">
                       <span class="px-2 py-1 rounded bg-white/10 text-[10px] font-bold">{{ activeFlight.status }}</span>
                   </div>
               </div>
               <div class="flex justify-between items-end mt-4">
                   <div>
                       <div class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">{{ t('terminal') }} {{ activeFlight.terminal }}</div>
                       <div class="text-[10px] text-gray-400 uppercase tracking-widest">{{ t('gate') }} <span class="text-white text-xl font-bold ml-1">{{ activeFlight.gate }}</span></div>
                   </div>
                   <div class="text-5xl font-light tracking-tight">{{ activeFlight.time }}</div>
               </div>
           </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
           <div class="ios-card p-4 flex flex-col justify-between h-44">
              <div class="flex justify-between items-start">
                 <div class="flex flex-col">
                    <span class="text-xs font-bold text-gray-400 uppercase truncate w-20">{{ displayCity }}</span>
                    <span class="text-4xl font-light mt-1 tracking-tighter">{{ weather.temp }}°</span>
                 </div>
                 <i :class="[weather.icon, weather.color]" class="ph-fill text-3xl"></i>
              </div>
              <div class="text-[10px] font-bold text-blue-500 mt-1 flex items-center gap-1">
                 <i class="ph-bold ph-cloud-rain"></i> {{ weather.precip }}% Rain
              </div>
              <div class="grid grid-cols-2 gap-x-1 gap-y-1 mt-auto pt-2 border-t border-gray-100/50">
                 <div class="text-[9px] text-gray-500">Feels {{ weather.feelsLike }}°</div>
                 <div class="text-[9px] text-gray-500">Hum {{ weather.humidity }}%</div>
                 <div class="text-[9px] text-gray-500">UV {{ weather.uv }}</div>
                 <div class="text-[9px] text-gray-500">Wind {{ weather.wind }}</div>
              </div>
           </div>

           <div class="ios-card p-4 flex flex-col justify-between h-44 relative" @click="rateDisplayMode = rateDisplayMode==='S_to_L'?'L_to_S':'S_to_L'">
              <div class="flex justify-between items-center z-10">
                 <div class="flex items-center gap-1 text-[10px] font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-lg">
                     <span>{{ rateDisplayMode === 'S_to_L' ? settings.currency.settle : settings.currency.local }}</span>
                     <i class="ph-bold ph-arrows-left-right text-blue-500"></i>
                     <span>{{ rateDisplayMode === 'S_to_L' ? settings.currency.local : settings.currency.settle }}</span>
                 </div>
              </div>
              <div class="z-10 mt-2">
                 <div class="text-3xl font-semibold tracking-tight text-gray-800 break-all">
                    {{ getRateDisplayValue() }}
                 </div>
                 <div class="text-[9px] text-gray-400 mt-1">Rate: {{ baseRate.toFixed(4) }}</div>
                 <div class="text-[8px] text-red-400 mt-2 font-medium bg-red-50 inline-block px-1.5 py-0.5 rounded">
                    +3% Fee Included
                 </div>
              </div>
           </div>
        </div>

        <div>
           <div class="flex justify-between items-end mb-2 px-1">
              <h3 class="text-lg font-bold text-gray-800">{{ t('itinerary') }}</h3>
           </div>
           
           <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 pl-1 snap-x">
              <div v-for="(day, idx) in tripDays" :key="idx" 
                   class="flex-shrink-0 w-16 h-20 rounded-xl flex flex-col items-center justify-center snap-start border transition-all"
                   :class="selectedDayIndex === idx ? 'bg-black text-white border-black shadow-lg scale-105' : 'bg-white border-gray-200 text-gray-400'"
                   @click="selectedDayIndex = idx">
                 <span class="text-[9px] font-bold uppercase tracking-wider mb-0.5">DAY {{ idx + 1 }}</span>
                 <span class="text-[10px] font-medium opacity-80">{{ day.weekday }}</span>
                 <span class="text-xl font-bold mt-0.5 leading-none">{{ day.dateStr.split(' ')[0] }}</span>
              </div>
              <div @click="openItineraryAdd" class="flex-shrink-0 w-16 h-20 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 snap-start active:bg-gray-100">
                  <i class="ph-bold ph-plus text-xl"></i>
              </div>
           </div>
           
           <div class="mt-2 space-y-3 min-h-[60px]">
              <div v-for="item in currentDayItinerary" :key="item.id" 
                   class="cal-stripe-item active:scale-[0.98] transition-transform"
                   @click="handleItineraryClick(item)">
                 <div class="item-time-box">
                    <span class="item-time-main">{{ item.time.split(':')[0] }}:{{ item.time.split(':')[1] }}</span>
                    <span class="item-time-sub">{{ parseInt(item.time) >= 12 ? 'PM' : 'AM' }}</span>
                 </div>
                 <div class="flex-1 min-w-0">
                    <div class="font-bold text-gray-900 text-[15px] truncate">{{ item.title }}</div>
                    <div class="text-xs text-gray-500 mt-0.5 truncate flex items-center gap-1">
                        <i v-if="item.location" class="ph-fill ph-map-pin text-blue-500 text-[10px]"></i>
                        {{ item.location || '---' }}
                    </div>
                 </div>
                 <div class="text-gray-300">
                    <i class="ph-bold ph-caret-right text-sm"></i>
                 </div>
              </div>
              <div v-if="currentDayItinerary.length === 0" class="text-center py-6 text-xs text-gray-400 bg-white/50 rounded-xl border border-dashed border-gray-200">
                 {{ t('noActivity') }}
              </div>
           </div>
        </div>

        <div>
           <div class="flex justify-between items-center mb-2 px-1">
              <h3 class="text-lg font-bold text-gray-800">Prep List</h3>
              <button @click="openSubPage('prep')" class="w-8 h-8 rounded-full bg-blue-500 text-white shadow flex items-center justify-center"><i class="ph-bold ph-plus"></i></button>
           </div>
           <div class="rounded-xl overflow-hidden shadow-sm" ref="homePrepListRef">
              <div v-for="item in prepList" :key="item.id" class="prep-item bg-white" :class="{ 'done': item.done }">
                 <div @click="item.done=!item.done; saveToCloud('prepList', prepList)" class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors flex-shrink-0" :class="item.done ? 'bg-green-500 border-green-500' : 'border-gray-300'">
                    <i v-if="item.done" class="ph-bold ph-check text-white text-[10px]"></i>
                 </div>
                 <span class="text-sm font-medium flex-1 text-gray-800">{{ item.text }}</span>
                 <button @click="editingId=item.id; editingItem={...item}; openSubPage('prep')" class="text-gray-400 p-2"><i class="ph-bold ph-pencil-simple"></i></button>
              </div>
           </div>
        </div>

      </div>
    </main>

    <main v-if="currentTab === 'itinerary'" class="flex-1 overflow-y-auto pb-32 pt-safe px-5 bg-white">
        <h2 class="text-3xl font-bold mb-4 text-black">{{ t('itinerary') }}</h2>
        
        <div class="sticky top-0 z-20 bg-white/95 backdrop-blur-xl py-2 -mx-5 px-5 border-b border-gray-100">
           <div class="flex gap-3 overflow-x-auto no-scrollbar snap-x">
              <div v-for="(day, idx) in tripDays" :key="idx" 
                   class="flex-shrink-0 w-16 h-20 rounded-xl flex flex-col items-center justify-center snap-start border transition-all"
                   :class="selectedDayIndex === idx ? 'bg-black text-white border-black' : 'bg-gray-50 border-gray-100 text-gray-400'"
                   @click="selectedDayIndex = idx">
                 <span class="text-[9px] font-bold uppercase mb-0.5">DAY {{ idx + 1 }}</span>
                 <span class="text-[10px] font-medium">{{ day.weekday }}</span>
                 <span class="text-xl font-bold mt-0.5">{{ day.dateStr.split(' ')[0] }}</span>
              </div>
           </div>
        </div>

        <div class="mt-6 space-y-3" ref="itineraryListRef">
            <div v-for="item in currentDayItinerary" :key="item.id" :data-id="item.id"
                 class="cal-stripe-item rounded-xl group active:scale-[0.98] transition-transform cursor-move"
                 @click="handleItineraryClick(item)">
               <div class="item-time-box">
                    <span class="item-time-main">{{ item.time }}</span>
               </div>
               <div class="flex-1 min-w-0">
                  <div class="font-bold text-gray-900 text-base truncate">{{ item.title }}</div>
                  <div class="text-sm text-gray-500 mt-1 truncate flex items-center gap-1">
                      <i v-if="item.location" class="ph-fill ph-map-pin text-gray-400"></i>
                      {{ item.location }}
                  </div>
               </div>
               <i class="ph-bold ph-dots-six-vertical text-gray-300"></i>
            </div>
        </div>
        
        <button @click="openItineraryAdd" class="w-full mt-4 py-4 rounded-xl border-2 border-dashed border-gray-200 text-gray-400 font-bold flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors">
            <i class="ph-bold ph-plus-circle text-xl"></i>
            {{ t('add') }}
        </button>
    </main>

    <main v-if="currentTab === 'expense'" class="flex-1 overflow-y-auto pb-32 pt-safe px-5">
        
        <div class="ios-card-dark-glass p-6 mb-6">
             <div class="dark-glass-gradient"></div>
             <div class="absolute top-4 left-4 z-10">
                <button @click="openMemberModal" class="bg-white/10 hover:bg-white/20 border border-white/10 text-white p-2 rounded-full backdrop-blur-md transition">
                    <i class="ph-bold ph-gear text-xl"></i>
                 </button>
             </div>
             <div class="absolute top-4 right-4 z-10">
                <button @click="openExpenseModal(null)" class="bg-white/10 hover:bg-white/20 border border-white/10 text-white p-2 rounded-full backdrop-blur-md transition">
                   <i class="ph-bold ph-plus text-xl"></i>
                </button>
             </div>
             
             <div class="relative z-10 flex flex-col items-center justify-center">
                 <div class="text-white/60 text-[11px] font-bold tracking-widest uppercase mb-1">TOTAL ({{ settings.currency.settle }})</div>
                 <div class="text-5xl font-light tracking-tight mb-2 text-white flex items-baseline">
                    <span class="text-2xl opacity-60 mr-1">$</span>{{ formatNumber(totalExpense.hkd, 0) }}
                 </div>
                 <div class="text-white/40 text-sm font-medium">≈ {{ settings.currency.local }} {{ formatNumber(totalExpense.twd, 0) }}</div>
             </div>
            
             <div class="grid grid-cols-2 gap-4 mt-6 relative z-10">
                <div class="bg-white/5 rounded-xl p-3 backdrop-blur-sm border border-white/5 flex flex-col items-center justify-center text-center">
                     <div class="text-white/50 text-[10px] uppercase tracking-wider mb-1"><i class="ph-bold ph-credit-card mr-1"></i>Card</div>
                    <div class="text-lg font-bold text-white mb-0.5">${{ formatNumber(totalExpense.creditHkd, 0) }}</div>
                </div>
                <div class="bg-white/5 rounded-xl p-3 backdrop-blur-sm border border-white/5 flex flex-col items-center justify-center text-center">
                    <div class="text-white/50 text-[10px] uppercase tracking-wider mb-1"><i class="ph-bold ph-coins mr-1"></i>Cash</div>
                    <div class="text-lg font-bold text-white mb-0.5">${{ formatNumber(totalExpense.cashHkd, 0) }}</div>
                </div>
             </div>
        </div>

        <div class="bg-gray-200/50 p-1 rounded-xl flex mb-6 mx-1 backdrop-blur-sm overflow-x-auto">
             <button v-for="f in ['all', 'credit', 'cash']" :key="f"
                @click="expenseFilter = f"
                class="flex-1 min-w-[60px] py-1.5 text-xs font-bold rounded-lg transition-all duration-200 whitespace-nowrap"
                :class="expenseFilter === f ? 'bg-white text-black shadow-sm' : 'text-gray-500 hover:text-gray-700'">
                {{ f === 'all' ? 'All' : (f === 'credit' ? 'Card' : 'Cash') }}
            </button>
            <button v-if="settlementStatus.hasData" 
                @click="expenseFilter = 'settlement'"
                class="flex-1 min-w-[60px] py-1.5 text-xs font-bold rounded-lg transition-all duration-200 whitespace-nowrap ml-1"
                :class="expenseFilter === 'settlement' ? 'bg-white text-black shadow-sm' : 'text-gray-500 hover:text-gray-700'">
                Settle
            </button>
        </div>

        <div v-if="expenseFilter === 'settlement'" class="space-y-3 pb-10">
            <div v-for="s in settlementList" :key="s.name" class="ios-card bg-white p-4 flex justify-between items-center">
                <div class="font-bold text-lg text-gray-800">{{ s.name }}</div>
                <div class="text-right">
                   <div class="text-[10px] uppercase text-gray-400 font-bold mb-0.5">
                        {{ s.amount >= 0 ? 'Receives' : 'Pays' }}
                   </div>
                   <div class="text-xl font-bold font-mono" :class="s.amount >= 0 ? 'text-[#34C759]' : 'text-[#FF3B30]'">
                        {{ s.amount >= 0 ? '+' : '' }}{{ formatNumber(s.amount, 0) }} <span class="text-[10px] text-gray-400 font-normal ml-0.5">{{ settings.currency.settle }}</span>
                   </div>
                </div>
            </div>
        </div>

        <div v-else class="space-y-3 pb-10">
           <div v-for="e in filteredExpenses" :key="e.id" 
                @click="openExpenseModal(e)"
                class="ios-card bg-white p-4 flex justify-between items-center active:scale-[0.99] transition-transform">
               <div class="flex items-center gap-4">
                   <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                       <i class="ph-fill text-lg" :class="getCategoryIcon(e.category)"></i>
                   </div>
                   <div>
                       <div class="font-bold text-gray-900 leading-tight">{{ e.name || e.category }}</div>
                       <div class="text-[10px] text-gray-400 mt-1 font-medium">
                           {{ e.payer }} paid • {{ e.date.split('-').slice(1).join('/') }}
                       </div>
                   </div>
               </div>
               <div class="text-right">
                   <div class="font-bold text-lg text-blue-600">
                       {{ formatNumber(e.amount, 0) }} <span class="text-xs text-gray-400">{{ e.currency }}</span>
                   </div>
                   <div class="text-[10px] text-gray-400 flex items-center justify-end gap-1">
                       <i class="ph-fill text-[10px]" :class="e.paymentMethod==='credit_card'?'ph-credit-card':'ph-coins'"></i>
                       {{ e.paymentMethod==='credit_card'?'Card':'Cash' }}
                   </div>
               </div>
           </div>
           <div v-if="filteredExpenses.length === 0" class="text-center py-10 text-gray-400 text-sm">No expenses yet.</div>
        </div>
    </main>

    <main v-if="currentTab === 'info'" class="flex-1 overflow-y-auto pb-32 pt-safe px-5 bg-gray-50">
         <h2 class="text-3xl font-bold mb-6 text-black">{{ t('info') }}</h2>
         <div class="grid grid-cols-1 gap-4">
             <div v-for="info in infoList" :key="info.id" @click="editingId=info.id; editingItem={...info}; openSubPage('info')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                 <h3 class="font-bold text-lg text-gray-900 mb-2">{{ info.title }}</h3>
                 <p class="text-sm text-gray-500 whitespace-pre-wrap leading-relaxed">{{ info.content }}</p>
             </div>
             <button @click="editingId=null; editingItem={title:'', content:''}; openSubPage('info')" class="w-full py-4 rounded-xl bg-white border-2 border-dashed border-gray-300 text-gray-400 font-bold hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                 <i class="ph-bold ph-plus"></i> {{ t('add') }}
             </button>
         </div>
    </main>

    <transition name="slide-up">
      <div v-if="activeSubPage === 'settings'" class="fixed inset-0 bg-[#F2F2F7] z-50 flex flex-col">
        <div class="bg-white px-5 pt-safe pb-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
           <button @click="closeSubPage" class="text-blue-500 font-medium text-lg flex items-center gap-1"><i class="ph-bold ph-caret-left"></i> {{ t('back') }}</button>
           <span class="font-bold text-lg text-gray-900">{{ t('settings') }}</span>
           <div class="w-16"></div>
        </div>
        <div class="flex-1 overflow-y-auto p-5 space-y-6">
           <div class="bg-white rounded-xl overflow-hidden shadow-sm p-4 flex justify-between items-center">
                <span>Flight Card Skin</span>
                <div class="bg-gray-100 p-1 rounded-lg flex">
                   <button @click="flightSkin='ios'; saveToCloud('skin', 'ios')" :class="flightSkin==='ios'?'bg-white shadow':''" class="px-4 py-1 rounded text-xs font-bold">iOS</button>
                   <button @click="flightSkin='hkg'; saveToCloud('skin', 'hkg')" :class="flightSkin==='hkg'?'bg-white shadow':''" class="px-4 py-1 rounded text-xs font-bold">HKG</button>
                </div>
           </div>
           <div class="bg-white rounded-xl overflow-hidden shadow-sm p-4 space-y-4">
               <div><label class="text-xs text-gray-400 font-bold uppercase">Origin</label><input v-model="settings.origin" class="w-full text-lg font-bold outline-none uppercase" @change="saveToCloud('settings', settings)"></div>
               <div><label class="text-xs text-gray-400 font-bold uppercase">Destination</label><input v-model="settings.destination" class="w-full text-lg font-bold outline-none uppercase" @change="saveToCloud('settings', settings)"></div>
               <div><label class="text-xs text-gray-400 font-bold uppercase">Weather City</label><input v-model="settings.weatherCity" class="w-full text-lg font-bold outline-none" @change="saveToCloud('settings', settings)"></div>
           </div>
           <button @click="if(confirm('Reset?')) {localStorage.clear(); location.reload()}" class="w-full py-4 text-red-500 bg-white rounded-xl font-bold">Reset All Data</button>
        </div>
      </div>
    </transition>

    <div v-if="showExpenseModal" class="modal-overlay" @click.self="showExpenseModal=false">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <button @click="showExpenseModal=false" class="text-gray-400 p-2"><i class="ph-bold ph-x text-xl"></i></button>
                <div class="flex bg-gray-800 rounded-lg p-1">
                    <button @click="editingExpense.currency=settings.currency.local" :class="editingExpense.currency===settings.currency.local?'bg-gray-600 text-white':'text-gray-500'" class="px-3 py-1 rounded text-xs font-bold transition">{{ settings.currency.local }}</button>
                    <button @click="editingExpense.currency=settings.currency.settle" :class="editingExpense.currency===settings.currency.settle?'bg-gray-600 text-white':'text-gray-500'" class="px-3 py-1 rounded text-xs font-bold transition">{{ settings.currency.settle }}</button>
                </div>
                <button v-if="editingExpense.id" @click="removeExpense(editingExpense.id)" class="text-red-500 p-2"><i class="ph-bold ph-trash text-xl"></i></button>
                <div v-else class="w-10"></div>
            </div>
            
            <div class="mb-6 text-right px-2">
                <div class="text-5xl font-light text-white tracking-tight">{{ calcDisplay }}</div>
                <div class="text-gray-500 text-xs mt-1 font-mono uppercase tracking-widest">Amount Input</div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <input v-model="editingExpense.name" placeholder="Item Name" class="bg-gray-800 rounded-xl px-4 py-3 text-white outline-none">
                <select v-model="editingExpense.category" class="bg-gray-800 rounded-xl px-4 py-3 text-white outline-none appearance-none">
                    <option value="food">Food</option><option value="transport">Transport</option><option value="shopping">Shopping</option>
                    <option value="ticket">Ticket</option><option value="stay">Stay</option><option value="other">Other</option>
                </select>
                <select v-model="editingExpense.payer" class="bg-gray-800 rounded-xl px-4 py-3 text-white outline-none appearance-none">
                    <option v-for="m in members" :key="m" :value="m">{{ m }} Pays</option>
                </select>
                <div class="flex bg-gray-800 rounded-xl p-1">
                     <button @click="editingExpense.paymentMethod='credit_card'" class="flex-1 rounded-lg text-xs font-bold" :class="editingExpense.paymentMethod==='credit_card'?'bg-gray-600 text-white':'text-gray-500'">Card</button>
                     <button @click="editingExpense.paymentMethod='cash'" class="flex-1 rounded-lg text-xs font-bold" :class="editingExpense.paymentMethod==='cash'?'bg-gray-600 text-white':'text-gray-500'">Cash</button>
                </div>
            </div>
            
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button v-for="m in members" :key="m" 
                    @click="toggleInvolved(m)"
                    class="px-3 py-1.5 rounded-full text-xs font-bold border transition-colors whitespace-nowrap"
                    :class="(editingExpense.involved.length===0 || editingExpense.involved.includes(m)) ? 'bg-blue-500/20 border-blue-500 text-blue-400' : 'border-gray-700 text-gray-500'">
                    {{ m }}
                </button>
            </div>

            <div class="grid grid-cols-4 gap-3">
                <button v-for="n in ['7','8','9','/']" :key="n" @click="handleCalcInput(n)" class="calc-btn" :class="'/'===n?'calc-op':'calc-num'">{{ n }}</button>
                <button v-for="n in ['4','5','6','*']" :key="n" @click="handleCalcInput(n)" class="calc-btn" :class="'*'===n?'calc-op':'calc-num'">{{ n }}</button>
                <button v-for="n in ['1','2','3','-']" :key="n" @click="handleCalcInput(n)" class="calc-btn" :class="'-'===n?'calc-op':'calc-num'">{{ n }}</button>
                <button @click="handleCalcInput('C')" class="calc-btn calc-action">C</button>
                <button @click="handleCalcInput('0')" class="calc-btn calc-num">0</button>
                <button @click="handleCalcInput('.')" class="calc-btn calc-num">.</button>
                <button @click="handleCalcInput('+')" class="calc-btn calc-op">+</button>
            </div>
            <button @click="saveExpenseResult" class="w-full bg-blue-500 text-white font-bold text-xl py-4 rounded-2xl mt-3 active:scale-[0.98] transition">
                {{ editingExpense.id ? 'Update Expense' : 'Add Expense' }}
            </button>
        </div>
    </div>

    <div v-if="showMemberModal" class="modal-overlay" @click.self="showMemberModal=false">
        <div class="modal-content bg-white text-gray-900 rounded-t-3xl">
            <h3 class="text-xl font-bold mb-4">Manage Members</h3>
            <div class="space-y-3 mb-6">
                <div v-for="m in members" :key="m" class="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                    <span class="font-bold">{{ m }}</span>
                    <button v-if="members.length > 1" @click="removeMember(m)" class="text-red-500 text-sm font-bold">Remove</button>
                </div>
            </div>
            <button @click="addMember" class="w-full py-4 bg-black text-white rounded-xl font-bold mb-3">Add Member</button>
            <button @click="showMemberModal=false" class="w-full py-4 text-gray-400 font-bold">Close</button>
        </div>
    </div>

    <transition name="slide-up">
        <div v-if="activeSubPage && !['settings','expense','flightEdit'].includes(activeSubPage)" class="fixed inset-0 bg-white z-50 flex flex-col">
            <div class="px-5 pt-safe pb-4 border-b border-gray-100 flex justify-between items-center">
                <button @click="closeSubPage" class="text-blue-500 font-medium text-lg">{{ t('cancel') }}</button>
                <span class="font-bold text-lg">{{ editingId ? t('edit') : t('new') }}</span>
                <button @click="saveGenericItem" class="text-blue-500 font-bold text-lg">{{ t('save') }}</button>
            </div>
            <div class="p-5 bg-gray-50 flex-1 space-y-4">
                <template v-if="activeSubPage === 'itinerary'">
                    <div class="bg-white p-4 rounded-xl shadow-sm grid grid-cols-2 gap-4">
                        <select v-model="editingItem.dayIndex" class="bg-gray-100 rounded-lg p-2 font-bold"><option v-for="(d,i) in tripDays" :key="i" :value="i">Day {{i+1}}</option></select>
                        <input type="time" v-model="editingItem.time" class="bg-gray-100 rounded-lg p-2 font-bold">
                    </div>
                    <input v-model="editingItem.title" placeholder="Title" class="w-full p-4 rounded-xl shadow-sm outline-none">
                    <input v-model="editingItem.location" placeholder="Location" class="w-full p-4 rounded-xl shadow-sm outline-none">
                </template>
                <template v-else>
                     <input v-if="activeSubPage==='prep'" v-model="editingItem.text" placeholder="Item" class="w-full p-4 rounded-xl shadow-sm outline-none">
                     <template v-if="activeSubPage==='info'">
                         <input v-model="editingItem.title" placeholder="Title" class="w-full p-4 rounded-xl shadow-sm outline-none font-bold">
                         <textarea v-model="editingItem.content" placeholder="Content" class="w-full p-4 h-40 rounded-xl shadow-sm outline-none"></textarea>
                     </template>
                </template>
                <button v-if="editingId" @click="deleteItem" class="w-full py-4 text-red-500 bg-white rounded-xl shadow-sm font-bold">Delete</button>
            </div>
        </div>
    </transition>

    <nav class="fixed bottom-0 w-full bg-white/90 backdrop-blur-xl border-t border-gray-200 pb-safe pt-2 flex justify-around items-center z-40">
      <button v-for="tab in ['home', 'itinerary', 'expense', 'info']" :key="tab" @click="currentTab = tab" class="flex flex-col items-center gap-1 w-16 transition-all" :class="currentTab === tab ? 'text-blue-500 scale-105' : 'text-gray-400'">
         <i :class="[currentTab === tab ? 'ph-fill' : 'ph-bold', {'home':'ph-house','itinerary':'ph-calendar-blank','expense':'ph-wallet','info':'ph-info'}[tab]]" class="text-2xl"></i>
         <span class="text-[10px] font-medium capitalize">{{ t(tab) }}</span>
      </button>
    </nav>

  </div>
</body>
</html>
