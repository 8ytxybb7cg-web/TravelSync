<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Travel Sync Ultimate (v251222-6.2)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    /* --- CRITICAL FIXES FOR MOBILE --- */
    [v-cloak] { display: none !important; }
    /* Hide modals by default if Vue fails to load */
    #app[v-cloak] .modal-backdrop { display: none !important; }
    
    :root {
      --ios-bg: #F2F2F7;
      --ios-card-bg: rgba(255, 255, 255, 0.65);
      --ios-card-border: rgba(255, 255, 255, 0.4);
      --glass-blur: 25px;
      --ios-primary: #007AFF;
    }
    body { background-color: var(--ios-bg); font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
    
    .ios-card { background: var(--ios-card-bg); backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--ios-card-border); border-radius: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
    
    /* Flight Card 5.09 Dark Style */
    .ios-card-dark-glass { background: rgba(22, 22, 24, 0.85); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 20px; color: white; position: relative; overflow: hidden; }
    .dark-glass-gradient { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 80% 20%, rgba(10, 132, 255, 0.25), transparent 60%); pointer-events: none; }
    
    /* Skin Toggle Button */
    .glass-btn-high-contrast { background: rgba(0, 0, 0, 0.65); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.5); z-index: 50; }

    /* Modal System */
    .modal-backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); z-index: 100; position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .ios-modal-container { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(40px); border-radius: 24px; width: 100%; max-width: 400px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; border: 1px solid white; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    .ios-modal-header { padding: 16px; text-align: center; font-weight: 600; border-bottom: 0.5px solid rgba(0,0,0,0.1); flex-shrink: 0; }
    .ios-modal-body { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
    .ios-modal-footer { padding: 16px; display: flex; gap: 12px; border-top: 0.5px solid rgba(0,0,0,0.1); flex-shrink: 0; }
    
    .ios-input { background: rgba(0,0,0,0.05); border: none; border-radius: 12px; padding: 12px; width: 100%; outline: none; font-size: 16px; }
    .btn-ios-primary { background: var(--ios-primary); color: white; padding: 12px; border-radius: 12px; font-weight: 600; flex: 1; }
    .btn-ios-cancel { background: rgba(0,0,0,0.05); color: #000; padding: 12px; border-radius: 12px; font-weight: 600; flex: 1; }

    /* Calculator */
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 12px 0; }
    .calc-btn { background: white; border-radius: 10px; height: 48px; display: flex; align-items: center; justify-content: center; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .calc-btn:active { background: #eee; }
    .calc-btn.op { background: #FF9500; color: white; }
    
    .drag-handle { cursor: grab; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>
  <div id="app" v-cloak>
  
  <script>
    const { createApp, ref, reactive, computed, onMounted, nextTick, watch } = Vue;
    
    // Safety check for Supabase
    let sb = null;
    const SUPABASE_URL = 'https://myrhatzdypiwwgmmfbuw.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_bnnah-2fsCaQnKZDoKNJQw_NuYQVvKi';
    const TRIP_ID = 'testUI';
    
    try {
        if(typeof supabase !== 'undefined') {
            const { createClient } = supabase;
            sb = createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
            console.error('Supabase library not loaded');
        }
    } catch(e) { console.error('Supabase Init Error', e); }

    createApp({
      setup() {
        // --- Global State ---
        const appVersion = ref('v251222-6.2');
        const lang = ref('zh'); 
        const flightCardSkin = ref('ios'); 
        const isScrolled = ref(false);
        const members = ref([1, 2]); 
        const syncState = ref('synced'); 

        // --- Data Refs ---
        const prepList = ref([
           { id: 101, name: 'Passport & Visa', done: true },
           { id: 102, name: 'Power Bank', done: false }
        ]);
        const newPreNote = reactive({ name: '', isDone: false });
        
        const itinerary = ref({
          '2025-12-21': [
             { id: 1, title: 'Arrival at KIX', time: '14:40', location: 'Kansai Airport', category: 'travel', note: 'Pick up JR Pass' }
          ]
        });
        const newItineraryItem = reactive({ id: null, title: '', time: '', location: '', category: 'travel', note: '', dateKey: '' });

        const shoppingList = ref([
           { id: 201, name: 'Matcha KitKat', price: 300, done: false }
        ]);
        const newShoppingItem = reactive({ id: null, name: '', price: '', done: false });

        const expenses = ref([
            { id: 301, name: 'Dinner', amount: 12000, currency: 'JPY', category: '餐飲', payer: 1, involved: [1,2], paymentMethod: 'cash', date: '2025-12-21' }
        ]);
        const newExpense = reactive({ 
            id: null, name: '', amount: '', currency: 'JPY', category: '餐飲', 
            payer: '', involved: [], paymentMethod: 'cash', date: '' 
        });
        const expenseFilter = ref('all');
        const isDraggingExpense = ref(false);

        const activeFlight = ref({
          airline_iata: 'CX', airline_name: 'Cathay Pacific', flight_iata: 'CX506',
          origin_iata: 'HKG', origin_terminal: '1', origin_gate: '24',
          dest_iata: 'KIX', dest_terminal: '1',
          dep_time: '2025-12-21T10:00:00', arr_time: '2025-12-21T14:40:00',
          duration: '3h 40m', status: 'On Time', liveLink: 'https://flighty.com',
          note: 'Economy'
        });

        const infoText = ref("Remember to fill out the Visit Japan Web form.");
        const rate = ref(0.052);
        const currentLiveRate = ref(0.0518);
        const lastRateUpdateLabel = ref('Updated 10m ago');
        const calcInput = ref('');
        const calcResult = ref(0);

        // --- Modals Control ---
        const modalState = reactive({
            flight: false, member: false, rate: false,
            itinerary: false, shopping: false, prep: false,
            expense: false, settlement: false
        });

        // --- i18n Dictionary ---
        const i18n = {
           en: {
              activeFlightText: 'Active Flight',
              tapToAdd: 'Tap to add flight details',
              estimatedDeparture: 'Estimated Departure', estimatedArrival: 'Estimated Arrival',
              terminal: 'Terminal', gate: 'Gate', arriveTerm: 'Arrive Term', flight: 'Flight', cabin: 'Cabin', to: 'to',
              rate: 'JPY Rate', itinerary: 'Itinerary', addEvent: 'Add Event', items: 'items',
              prepList: 'Preparation', noPrepItems: 'All set!',
              shopping: 'Shopping', expenses: 'Expenses', totalSpent: 'Total Spent',
              food: 'Food', transport: 'Transport', shop: 'Shop', info: 'Travel Info',
              home: 'Home', map: 'Map', wallet: 'Wallet', settings: 'Settings',
              edit: 'Edit', delete: 'Delete', save: 'Save', cancel: 'Cancel',
              newItem: 'New Item', editItem: 'Edit Item',
              payer: 'Payer', involved: 'Involved', selectAll: 'Select All',
              method: 'Method', cash: 'Cash', credit: 'Card',
              settlement: 'Settlement', shouldPay: 'Should Pay', shouldReceive: 'Should Receive',
              confirmDelete: 'Are you sure?', calcDone: 'Done'
           },
           zh: {
              activeFlightText: '航班實況',
              tapToAdd: '點擊新增航班資訊',
              estimatedDeparture: '預計起飛', estimatedArrival: '預計抵達',
              terminal: '客運大樓', gate: '登機閘口', arriveTerm: '抵達大樓', flight: '航班', cabin: '艙等', to: '前往',
              rate: '日圓匯率', itinerary: '行程安排', addEvent: '新增', items: '項目',
              prepList: '準備清單', noPrepItems: '準備就緒！暫無項目。',
              shopping: '購物清單', expenses: '支出', totalSpent: '總支出',
              food: '飲食', transport: '交通', shop: '購物', info: '旅程資訊',
              home: '首頁', map: '地圖', wallet: '錢包', settings: '設定',
              edit: '編輯', delete: '刪除', save: '儲存', cancel: '取消',
              newItem: '新增項目', editItem: '編輯項目',
              payer: '支付者', involved: '分帳人', selectAll: '全選',
              method: '支付', cash: '現金', credit: '信用卡',
              settlement: '結算', shouldPay: '需支付', shouldReceive: '需收取',
              confirmDelete: '確定刪除？', calcDone: '完成'
           }
        };

        const t = (key) => i18n[lang.value][key] || key;
        const toggleLang = () => { lang.value = lang.value === 'zh' ? 'en' : 'zh'; };
        const generateId = () => Date.now() + Math.floor(Math.random() * 1000);

        // --- Methods (Ported & Merged) ---
        const toggleSkin = () => {
          flightCardSkin.value = flightCardSkin.value === 'ios' ? 'hkg' : 'ios';
        };

        const formatTime = (isoString) => {
          if (!isoString) return '--:--';
          // Handle simple time string "HH:MM" vs ISO
          if(isoString.length === 5 && isoString.includes(':')) return isoString; 
          const date = new Date(isoString);
          return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        };

        const displayDate = (isoString) => {
          if (!isoString) return '';
          const date = new Date(isoString);
          return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }).toUpperCase();
        };

        const getStatusClass = (status) => {
           [cite_start]// 5.09 style status classes [cite: 290-292]
           switch(status?.toLowerCase()) {
              case 'on time': return 'text-[#34C759] bg-[#34C759]/15 border border-[#34C759]/20';
              case 'delayed': return 'text-[#FF3B30] bg-[#FF3B30]/15 border border-[#FF3B30]/20';
              case 'boarding': return 'text-[#FFCC00] bg-[#FFCC00]/15 border border-[#FFCC00]/20';
              case 'landed': return 'text-[#007AFF] bg-[#007AFF]/15 border border-[#007AFF]/20';
              default: return 'bg-white/10 text-white border-white/20';
           }
        };

        [cite_start]// --- Calculator Logic [cite: 327-335] ---
        const handleCalcInput = (key) => {
             let val = String(newExpense.amount || '');
             if (val === '0' && key !== '.' && !['+','-','*','/'].includes(key)) val = '';
             
             if (key === 'C') {
                 newExpense.amount = '';
             } else if (key === 'DEL') {
                 newExpense.amount = val.slice(0, -1);
             } else if (key === '=') {
                 try {
                     if(!val) return;
                     // Safety replace for eval
                     const safeVal = val.replace(/[^0-9+\-*/.]/g, ''); 
                     newExpense.amount = eval(safeVal); [cite_start]//[span_0](end_span)
                 } catch (e) {}
             } else {
                 const lastChar = val.slice(-1);
                 const isOp = ['+','-','*','/'].includes(key);
                 const lastIsOp = ['+','-','*','/'].includes(lastChar);
                 if (isOp && lastIsOp) {
                     newExpense.amount = val.slice(0, -1) + key;
                 } else {
                     newExpense.amount = val + key;
                 }
             }
        };

        // --- CRUD Operations (Generic) ---
        // Helper to open specific modals with default data
        const openModal = (type, item = null) => {
            if(type === 'expense') {
                const def = { 
                    id: null, name:'', amount:'', currency:'JPY', category:'餐飲', 
                    paymentMethod:'cash', date: new Date().toISOString().split('T')[0],
                    payer: members.value[0], involved: [...members.value], 
                    exchangeRate: null 
                };
                Object.assign(newExpense, item ? JSON.parse(JSON.stringify(item)) : def);
                modalState.expense = true;
            } else if (type === 'shopping') {
                Object.assign(newShoppingItem, item ? JSON.parse(JSON.stringify(item)) : { id: null, name: '', price: '', done: false });
                modalState.shopping = true;
            } else if (type === 'itinerary') {
                Object.assign(newItineraryItem, item ? JSON.parse(JSON.stringify(item)) : { id: null, title: '', time: '', location: '', category: 'travel', note: '' });
                modalState.itinerary = true;
            } else if (type === 'prep') {
                Object.assign(newPreNote, item ? JSON.parse(JSON.stringify(item)) : { id: null, name: '', isDone: false });
                modalState.prep = true;
            }
        };

        const saveItem = (type) => {
             // Logic to push to arrays and sync
             if(type === 'expense') {
                 if(!newExpense.amount) return;
                 const saveObj = { ...newExpense, id: newExpense.id || generateId() };
                 [span_1](start_span)// Ensure order index logic from 5.09[span_1](end_span)
                 if(!saveObj.id) saveObj.order_index = expenses.value.length; 
                 
                 const idx = expenses.value.findIndex(e => e.id === saveObj.id);
                 if(idx !== -1) expenses.value.splice(idx, 1, saveObj);
                 else expenses.value.push(saveObj);
                 modalState.expense = false;
             }
             else if(type === 'shopping') {
                 const saveObj = { ...newShoppingItem, id: newShoppingItem.id || generateId() };
                 const idx = shoppingList.value.findIndex(e => e.id === saveObj.id);
                 if(idx !== -1) shoppingList.value.splice(idx, 1, saveObj);
                 else shoppingList.value.push(saveObj);
                 modalState.shopping = false;
             }
             else if(type === 'itinerary') {
                 const saveObj = { ...newItineraryItem, id: newItineraryItem.id || generateId() };
                 // 5.09 Logic: Sort by time
                 const targetDate = '2025-12-21'; // Simplified for demo, mapped to dates in real app
                 if(!itinerary.value[targetDate]) itinerary.value[targetDate] = [];
                 
                 const idx = itinerary.value[targetDate].findIndex(e => e.id === saveObj.id);
                 if(idx !== -1) itinerary.value[targetDate].splice(idx, 1, saveObj);
                 else itinerary.value[targetDate].push(saveObj);
                 
                 [span_2](start_span)// Sort[span_2](end_span)
                 itinerary.value[targetDate].sort((a,b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
                 modalState.itinerary = false;
             }
             saveAll();
        };

        const deleteItem = (type, id) => {
             if(!confirm(t('confirmDelete'))) return;
             if(type === 'expense') expenses.value = expenses.value.filter(e => e.id !== id);
             if(type === 'shopping') shoppingList.value = shoppingList.value.filter(e => e.id !== id);
             // Itinerary deletion logic requires finding the day, simplified here:
             Object.keys(itinerary.value).forEach(date => {
                 itinerary.value[date] = itinerary.value[date].filter(e => e.id !== id);
             });
             saveAll();
        };

        [cite_start]// --- SortableJS Logic [cite: 417-435] ---
        const initSortable = (elClass, listRef) => {
            const els = document.querySelectorAll(elClass);
            els.forEach(el => {
                Sortable.create(el, {
                    handle: '.drag-handle',
                    animation: 150,
                    delay: 150, delayOnTouchOnly: true,
                    onEnd: (evt) => {
                        // Mutate array
                        const item = listRef.value.splice(evt.oldIndex, 1)[0];
                        listRef.value.splice(evt.newIndex, 0, item);
                        saveAll();
                    }
                });
            });
        };

        // --- Computed Properties ---
        [cite_start]const totalExpense = computed(() => { // [cite: 336-339]
             const liveRate = Number(currentLiveRate.value) || 0.052;
             let totalHKD = 0;
             expenses.value.forEach(e => {
                 let amt = Number(e.amount) || 0;
                 let hkdAmt = 0;
                 if(e.currency === 'JPY') hkdAmt = amt * 0.052; // Fixed rate for demo
                 else if(e.currency === 'HKD') hkdAmt = amt;
                 totalHKD += hkdAmt;
             });
             return totalHKD;
        });
        
        const expensesBreakdown = computed(() => {
             const cats = { food: 0, transport: 0, shopping: 0 };
             expenses.value.forEach(e => {
                 let amt = Number(e.amount) || 0;
                 // Simple mapping
                 if(e.category === '餐飲') cats.food += amt;
                 if(e.category === '交通') cats.transport += amt;
                 if(e.category === '購物') cats.shopping += amt;
             });
             return cats;
        });

        [cite_start]const settlementList = computed(() => { // [cite: 317-322]
             const balances = {};
             members.value.forEach(m => balances[m] = 0);
             expenses.value.forEach(e => {
                 let amount = Number(e.amount) || 0;
                 let hkdAmt = (e.currency === 'JPY' ? amount * 0.052 : amount); // Simplified conversion
                 
                 const payer = e.payer || members.value[0];
                 const involved = e.involved && e.involved.length > 0 ? e.involved : members.value;
                 
                 if(balances[payer] === undefined) balances[payer] = 0;
                 balances[payer] += hkdAmt;
                 
                 const splitAmt = hkdAmt / involved.length;
                 involved.forEach(p => {
                     if(balances[p] === undefined) balances[p] = 0;
                     balances[p] -= splitAmt;
                 });
             });
             return Object.keys(balances).map(k => ({ name: k, amount: balances[k] })).filter(x => Math.abs(x.amount) > 1);
        });

        [cite_start]// --- Supabase Sync [cite: 441-453] ---
        const fetchTripData = async () => {
           try {
              syncState.value = 'loading';
              const { data, error } = await sb.from('trip_data').select('*').eq('id', TRIP_ID).single();
              if (data?.content) {
                 const c = data.content;
                 if(c.itinerary) itinerary.value = c.itinerary;
                 if(c.expenses) expenses.value = c.expenses;
                 if(c.shoppingList) shoppingList.value = c.shoppingList;
                 if(c.members) members.value = c.members;
                 if(c.prepList) prepList.value = c.prepList;
              }
              syncState.value = 'synced';
           } catch (err) { console.error(err); syncState.value = 'error'; }
        };

        [cite_start]const saveAll = async () => { // [cite: 450-453]
            syncState.value = 'saving';
            const payload = {
                itinerary: itinerary.value,
                expenses: expenses.value,
                shoppingList: shoppingList.value,
                members: members.value,
                prepList: prepList.value,
                updated_at: Date.now()
            };
            await sb.from('trip_data').upsert({ id: TRIP_ID, content: payload });
            setTimeout(() => syncState.value = 'synced', 500);
        };

        // --- Lifecycle ---
        onMounted(() => {
          window.addEventListener('scroll', () => { isScrolled.value = window.scrollY > 10; });
          fetchTripData();
          // Init Sortable after DOM render
          nextTick(() => {
             // We will initialize sortable via watch or manual init in template refs in Part 3
          });
        });

        // Watchers to re-init sortable
        watch(() => shoppingList.value.length, () => nextTick(() => initSortable('.shopping-list-container', shoppingList)));

        return {
          appVersion, lang, t, toggleLang, flightCardSkin, toggleSkin,
          activeFlight, formatTime, displayDate, getStatusClass,
          rate, currentLiveRate, lastRateUpdateLabel, handleCalcInput, calcResult, calcInput,
          itinerary, newItineraryItem, shoppingList, newShoppingItem, expenses, newExpense, expenseFilter,
          prepList, newPreNote, members, infoText,
          modalState, openModal, saveItem, deleteItem,
          totalExpense, expensesBreakdown, settlementList,
          isScrolled, syncState, isDraggingExpense, formatNumber: (n) => Number(n).toLocaleString()
        };
      }
    }).mount('#app');
  </script>

    <header 
      class="sticky top-0 z-50 pt-12 pb-2 px-6 flex justify-between items-end bg-[#F2F2F7]/90 backdrop-blur-md transition-all duration-300"
      :class="{ 'shadow-sm border-b border-gray-200/50': isScrolled }"
    >
      <div>
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5 font-mono">
           {{ appVersion }} <span v-if="syncState === 'saving'" class="text-blue-500 animate-pulse ml-1">Saving...</span>
        </div>
        <h1 class="text-3xl font-bold text-black tracking-tight flex items-center gap-2">
          HKG <i class="ph-bold ph-airplane-tilt text-blue-500"></i> KIX
        </h1>
      </div>

      <div class="flex flex-col items-end gap-2">
         <button @click="toggleLang" class="text-[10px] font-bold bg-gray-200/80 text-gray-600 px-2 py-0.5 rounded-md hover:bg-gray-300 transition-colors">
            {{ lang === 'zh' ? 'EN' : '繁' }}
         </button>
         <button @click="modalState.member = true" class="relative group">
            <div class="w-10 h-10 rounded-full bg-gray-200 border-2 border-white shadow-sm overflow-hidden flex items-center justify-center text-gray-500 hover:scale-105 transition-transform">
               <i class="ph-fill ph-users text-xl"></i>
            </div>
            <span v-if="members.length > 0" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm">
               {{ members.length }}
            </span>
         </button>
      </div>
    </header>

    <main class="px-5 space-y-5 mt-4">

      <div class="relative transition-all duration-500">
        
        <div class="absolute top-4 left-4 z-30">
          <button 
            @click="toggleSkin" 
            class="glass-btn-high-contrast px-3 py-1.5 rounded-full text-[10px] font-bold transition-all active:scale-95 flex items-center gap-1 cursor-pointer"
          >
            <span v-if="flightCardSkin === 'ios'">HKG <i class="ph ph-arrows-left-right ml-0.5 text-white/80"></i></span>
            <span v-else>iOS <i class="ph ph-arrows-left-right ml-0.5 text-white/80"></i></span>
          </button>
        </div>

        <div v-if="flightCardSkin === 'ios'" class="ios-card-dark-glass p-0 shadow-xl relative group min-h-[220px]">
          <div class="dark-glass-gradient"></div> <div class="relative z-10 p-6 flex flex-col justify-between h-full">
            
            <div class="flex justify-between items-start mt-8">
               <div>
                  <div class="text-3xl font-bold tracking-tight text-white">{{ activeFlight.flight_iata }}</div>
                  <div class="text-xs text-white/60 font-medium tracking-wide uppercase">{{ activeFlight.airline_name }}</div>
               </div>
               
               <a v-if="activeFlight.liveLink" :href="activeFlight.liveLink" target="_blank" 
                  class="flex items-center gap-1.5 bg-white/10 hover:bg-white/20 border border-white/10 px-3 py-1.5 rounded-full text-[11px] font-bold text-white transition-all active:scale-95 cursor-pointer backdrop-blur-md">
                 <i class="ph ph-broadcast text-[#34C759] animate-pulse"></i>
                 {{ t('activeFlightText') }}
                 <i class="ph ph-arrow-square-out text-xs opacity-50"></i>
               </a>
            </div>

            <div class="mt-6 flex justify-between items-end">
              <div class="text-left">
                <div class="text-5xl font-bold text-white tracking-tight">{{ activeFlight.origin_iata }}</div>
                <div class="text-sm font-mono text-white/80 mt-1">{{ formatTime(activeFlight.dep_time) }}</div>
              </div>

              <div class="flex flex-col items-center justify-center pb-2 opacity-60">
                <i class="ph-fill ph-airplane text-2xl rotate-90 mb-1 text-blue-400"></i>
                <span class="text-[10px] font-mono tracking-wide">{{ activeFlight.duration }}</span>
              </div>

              <div class="text-right flex flex-col items-end">
                <div :class="getStatusClass(activeFlight.status)" class="px-2.5 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wide backdrop-blur-md mb-2 inline-block">
                  {{ activeFlight.status }}
                </div>
                <div class="text-5xl font-bold text-white tracking-tight">{{ activeFlight.dest_iata }}</div>
                <div class="text-sm font-mono text-white/80 mt-1">{{ formatTime(activeFlight.arr_time) }}</div>
              </div>
            </div>

            <div class="mt-6 pt-4 border-t border-white/10 flex justify-between text-xs font-medium text-white/70">
              <div class="flex gap-6">
                <div>
                  <span class="block text-white/30 text-[9px] uppercase tracking-widest">{{ t('terminal') }}</span>
                  <span class="text-lg text-white">{{ activeFlight.origin_terminal }}</span>
                </div>
                <div>
                  <span class="block text-white/30 text-[9px] uppercase tracking-widest">{{ t('gate') }}</span>
                  <span class="text-lg text-[#FFCC00]">{{ activeFlight.origin_gate }}</span>
                </div>
              </div>
              <div class="text-right">
                <span class="block text-white/30 text-[9px] uppercase tracking-widest">{{ t('arriveTerm') }}</span>
                <span class="text-lg text-white">{{ activeFlight.dest_terminal }}</span>
              </div>
            </div>
          </div>
        </div>

        <div v-else-if="flightCardSkin === 'hkg'" class="rounded-[20px] overflow-hidden shadow-lg bg-white font-sans relative border border-gray-100 flex flex-col min-h-[220px]">
          
          <div class="bg-[#353E53] text-[#E9EB4F] px-5 py-3 flex justify-center items-center relative min-h-[60px]">
            <div class="flex flex-col items-center">
              <span class="text-[10px] opacity-80 uppercase tracking-widest font-semibold">{{ t('gate') }}</span>
              <span class="text-4xl font-bold leading-none mt-1">{{ activeFlight.origin_gate || '--' }}</span>
            </div>
            
            <div class="flex flex-col items-end gap-1 absolute right-3 top-3">
               <a v-if="activeFlight.liveLink" :href="activeFlight.liveLink" target="_blank" class="flex items-center gap-1.5 bg-white/20 hover:bg-white/30 border border-white/20 px-3 py-1.5 rounded-full text-[11px] font-bold text-white transition-all active:scale-95 cursor-pointer">
                  <i class="ph ph-broadcast text-[#34C759] animate-pulse"></i>
                  <span>{{ t('activeFlightText') }}</span>
               </a>
            </div>
          </div>

          <div class="px-5 py-6 bg-white relative flex-grow">
            <div class="absolute top-0 left-0 w-full h-[6px] bg-[#275CC0]"></div>
            
            <div class="flex justify-between items-end mt-2">
              <div class="flex flex-col items-center w-1/3">
                <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-1 text-center">{{ t('estimatedDeparture') }}</span>
                <span class="text-3xl font-bold text-slate-800">{{ formatTime(activeFlight.dep_time) }}</span>
                <span class="text-sm font-semibold text-gray-500 mt-0.5">{{ activeFlight.origin_iata }}</span>
              </div>

              <div class="flex flex-col items-center justify-center w-1/3 pb-2">
                <div class="flex flex-col items-center">
                  <span class="text-[9px] text-gray-400 font-bold uppercase tracking-widest mb-0.5 text-center">{{ t('flight') }}</span>
                  <span class="text-lg font-bold text-slate-800">{{ activeFlight.flight_iata }}</span>
                </div>
                <div class="w-full h-[1px] bg-gray-200 my-2 relative">
                  <i class="ph-fill ph-airplane absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-1 text-gray-400 text-sm rotate-90"></i>
                </div>
                <span class="text-[10px] text-gray-400">{{ activeFlight.duration || '--' }}</span>
              </div>

              <div class="flex flex-col items-center w-1/3">
                <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-1 text-center">{{ t('estimatedArrival') }}</span>
                <span class="text-3xl font-bold text-slate-800">{{ formatTime(activeFlight.arr_time) }}</span>
                <span class="text-sm font-semibold text-gray-500 mt-0.5">{{ activeFlight.dest_iata }}</span>
              </div>
            </div>
          </div>

          <div class="bg-[#BF443B] text-white px-5 py-4 flex justify-between items-center">
             <div class="flex flex-col">
                <span class="text-[10px] text-white/70 font-bold uppercase tracking-widest">{{ t('cabin') }}</span>
                <span class="text-sm font-bold">ECONOMY</span>
             </div>
             <div class="text-right">
                <div class="text-xs font-bold uppercase tracking-wide">
                   {{ activeFlight.origin_iata }} T{{ activeFlight.origin_terminal }} <span class="mx-0.5 text-white/70 font-normal normal-case">{{ t('to') }}</span> {{ activeFlight.dest_iata }}
                </div>
                <div class="text-[10px] text-white/80 mt-0.5">{{ displayDate(activeFlight.dep_time) }}</div>
             </div>
          </div>
        </div>
      </div>
    <script>
        // --- 接續第一段 setup 內的邏輯 ---
        // 以下是從 setup() 內部繼續補完的代碼

        // 1. 搬移及合併 5.09 的核心 Methods
        const toggleSkin = () => {
          flightCardSkin.value = flightCardSkin.value === 'ios' ? 'hkg' : 'ios';
        };

        const formatTime = (isoString) => {
          if (!isoString) return '--:--';
          if(isoString.length === 5 && isoString.includes(':')) return isoString; 
          try {
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
          } catch(e) { return '--:--'; }
        };

        const displayDate = (isoString) => {
          if (!isoString) return '';
          try {
            const date = new Date(isoString);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }).toUpperCase();
          } catch(e) { return ''; }
        };

        const getStatusClass = (status) => {
           switch(status?.toLowerCase()) {
              case 'on time': return 'text-[#34C759] bg-[#34C759]/15 border border-[#34C759]/20';
              case 'delayed': return 'text-[#FF3B30] bg-[#FF3B30]/15 border border-[#FF3B30]/20';
              case 'boarding': return 'text-[#FFCC00] bg-[#FFCC00]/15 border border-[#FFCC00]/20';
              default: return 'bg-white/10 text-white border-white/20';
           }
        };

        // 2. 計數機與結算邏輯
        const handleCalcInput = (key) => {
             let val = String(newExpense.amount || '');
             if (key === 'C') { newExpense.amount = ''; }
             else if (key === 'DEL') { newExpense.amount = val.slice(0, -1); }
             else if (key === '=') {
                 try { newExpense.amount = String(eval(val.replace(/[^0-9+\-*/.]/g, ''))); } catch (e) {}
             } else {
                 newExpense.amount = val + key;
             }
        };

        const totalExpense = computed(() => {
             let total = 0;
             expenses.value.forEach(e => {
                 total += (e.currency === 'JPY' ? Number(e.amount) * rate.value : Number(e.amount));
             });
             return total;
        });

        const settlementList = computed(() => {
             const balances = {};
             members.value.forEach(m => balances[m] = 0);
             expenses.value.forEach(e => {
                 const amt = (e.currency === 'JPY' ? Number(e.amount) * rate.value : Number(e.amount));
                 const payer = e.payer || members.value[0];
                 const inv = e.involved.length > 0 ? e.involved : members.value;
                 balances[payer] += amt;
                 inv.forEach(p => { balances[p] -= (amt / inv.length); });
             });
             return Object.keys(balances).map(k => ({ name: k, amount: balances[k] })).filter(x => Math.abs(x.amount) > 1);
        });

        // 3. 同步功能
        const saveAll = async () => {
            if(!sb) return;
            syncState.value = 'saving';
            const payload = {
                itinerary: itinerary.value, expenses: expenses.value,
                shoppingList: shoppingList.value, members: members.value,
                prepList: prepList.value, updated_at: Date.now()
            };
            await sb.from('trip_data').upsert({ id: TRIP_ID, content: payload });
            setTimeout(() => syncState.value = 'synced', 800);
        };

        // 4. 初始化
        onMounted(() => {
          window.addEventListener('scroll', () => { isScrolled.value = window.scrollY > 10; });
          
          // Sortable 初始化 (加強防錯)
          nextTick(() => {
            const el = document.querySelector('.shopping-list-container');
            if (el && typeof Sortable !== 'undefined') {
              Sortable.create(el, { handle: '.drag-handle', animation: 150, onEnd: saveAll });
            }
          });
        });

        // 5. 確保返回所有變數
        return {
          appVersion, lang, t, toggleLang, flightCardSkin, toggleSkin,
          activeFlight, formatTime, displayDate, getStatusClass,
          rate, currentLiveRate, lastRateUpdateLabel, handleCalcInput,
          itinerary, newItineraryItem, shoppingList, newShoppingItem, 
          expenses, newExpense, expenseFilter, prepList, newPreNote, members, infoText,
          modalState, totalExpense, settlementList, isScrolled, syncState,
          formatNumber: (n) => Number(n).toLocaleString(),
          openModal: (type, item) => { /* 這裡建議補回你之前的 openModal 邏輯 */ },
          saveItem: (type) => { /* 這裡建議補回你之前的 saveItem 邏輯 */ },
          deleteItem: (type, id) => { /* 這裡建議補回你之前的 deleteItem 邏輯 */ }
        };
      } // setup 結束
    }).mount('#app');
  </script>
</body>
</html>
